
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Quiz Host - Complete Multiplayer</title>
<!-- VERSION: 5.0 - Clear your cache! -->
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:ital,wght@0,400;0,600;0,700;1,400&family=Barlow:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

<!-- 
  FIREBASE SETUP REQUIRED
  Replace the firebaseConfig below with your own Firebase configuration
  Get it from: Firebase Console > Project Settings > Your apps > Config
-->

<style>
  :root {
    --motd-magenta: #d4145a;
    --motd-red: #c81e5b;
    --motd-navy: #2c3e69;
    --motd-dark-navy: #1a2540;
    --motd-blue: #3e5c8f;
    --motd-cyan: #4dd4e8;
    --motd-gold: #ffc629;
    --text: #ffffff;
    --text-muted: #a8b4d0;
    --border: #3e5c8f;
  }
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: 'Barlow', sans-serif;
    background: linear-gradient(135deg, var(--motd-dark-navy) 0%, var(--motd-navy) 50%, var(--motd-blue) 100%);
    color: var(--text);
    min-height: 100vh;
    overflow: hidden;
  }
  
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      radial-gradient(circle at 20% 50%, rgba(212,20,90,0.15) 0%, transparent 50%),
      radial-gradient(circle at 80% 80%, rgba(77,212,232,0.1) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }
  
  .container {
    position: relative;
    z-index: 1;
    height: 100vh;
    display: flex;
    flex-direction: column;
  }
  
  /* HEADER */
  .host-header {
    background: linear-gradient(160deg, var(--motd-dark-navy) 0%, var(--motd-navy) 100%);
    border-bottom: 3px solid var(--motd-cyan);
    padding: 20px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 4px 30px rgba(77,212,232,0.2);
  }
  
  .game-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 42px;
    letter-spacing: 3px;
    color: var(--text);
    text-shadow: 0 0 30px rgba(212,20,90,0.8);
  }
  
  .header-right {
    display: flex;
    gap: 20px;
    align-items: center;
  }
  
  .game-code-display {
    background: rgba(0,0,0,0.4);
    border: 2px solid var(--motd-cyan);
    padding: 12px 24px;
    border-radius: 8px;
  }
  
  .code-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 3px;
  }
  
  .code-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    letter-spacing: 6px;
    color: var(--motd-cyan);
    text-shadow: 0 0 20px rgba(77,212,232,0.6);
  }
  
  .round-indicator {
    background: var(--motd-magenta);
    padding: 8px 20px;
    border-radius: 6px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    letter-spacing: 2px;
  }
  
  /* MAIN CONTENT */
  .main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    padding: 30px 40px;
    overflow-y: auto;
  }
  
  /* TEAM SELECTION */
  .team-selection-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
  }
  
  .team-selection-screen.hidden {
    display: none;
  }
  
  .team-selection-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 56px;
    letter-spacing: 4px;
    color: var(--text);
    text-shadow: 0 0 40px rgba(212,20,90,0.8);
    margin-bottom: 15px;
  }
  
  .team-selection-subtitle {
    font-family: 'Barlow', sans-serif;
    font-size: 18px;
    color: var(--text-muted);
    margin-bottom: 40px;
  }
  
  .teams-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px;
    max-width: 1200px;
    width: 100%;
    margin-bottom: 30px;
    max-height: 400px;
    overflow-y: auto;
    padding: 10px;
  }
  
  .team-option {
    background: var(--motd-navy);
    border: 3px solid var(--border);
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .team-option:hover {
    border-color: var(--motd-cyan);
    transform: translateY(-3px);
  }
  
  .team-option.selected {
    border-color: var(--motd-gold);
    background: rgba(255,198,41,0.15);
  }
  
  .team-flag {
    font-size: 48px;
    margin-bottom: 10px;
  }
  
  .team-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--text);
  }
  
  .selected-teams-display {
    display: flex;
    gap: 40px;
    margin-bottom: 30px;
  }
  
  .selected-team-card {
    background: var(--motd-navy);
    border: 3px solid var(--motd-gold);
    padding: 25px 40px;
    border-radius: 8px;
    min-width: 200px;
    text-align: center;
  }
  
  .selected-team-flag {
    font-size: 64px;
    margin-bottom: 10px;
  }
  
  .selected-team-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    letter-spacing: 3px;
    color: var(--motd-gold);
  }
  
  .vs-text {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    color: var(--text-muted);
    align-self: center;
  }
  
  .confirm-teams-btn {
    background: linear-gradient(135deg, var(--motd-magenta) 0%, var(--motd-red) 100%);
    color: white;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 4px;
    padding: 16px 40px;
    cursor: pointer;
    border-radius: 8px;
    box-shadow: 0 4px 30px rgba(212,20,90,0.5);
    transition: all 0.2s;
  }
  
  .confirm-teams-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 40px rgba(212,20,90,0.7);
  }
  
  .confirm-teams-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* LOBBY SCREEN */
  .lobby-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
  }
  
  .lobby-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 64px;
    letter-spacing: 5px;
    color: var(--text);
    text-shadow: 0 0 40px rgba(212,20,90,0.8);
    margin-bottom: 15px;
  }
  
  .lobby-subtitle {
    font-family: 'Barlow', sans-serif;
    font-size: 20px;
    color: var(--text-muted);
    margin-bottom: 40px;
  }
  
  .qr-code-container {
    background: white;
    padding: 25px;
    border-radius: 12px;
    margin-bottom: 30px;
    border: 3px solid var(--motd-navy);
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  #qr-code {
    width: 220px;
    height: 220px;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  
  #qr-code canvas,
  #qr-code img {
    max-width: 220px !important;
    max-height: 220px !important;
    display: block !important;
  }
  
  #qr-code > * {
    margin: 0 !important;
  }
  
  .join-url {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 24px;
    color: var(--motd-cyan);
    margin-bottom: 40px;
  }
  
  .players-waiting {
    width: 100%;
    max-width: 1200px;
    margin-bottom: 30px;
  }
  
  .players-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
    margin-top: 15px;
  }
  
  .player-card {
    background: var(--motd-navy);
    border: 2px solid var(--border);
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    animation: slideIn 0.3s ease;
    position: relative;
  }
  
  .player-card.team1 {
    border-left: 5px solid var(--motd-cyan);
  }
  
  .player-card.team2 {
    border-left: 5px solid var(--motd-magenta);
  }
  
  .player-team-badge {
    position: absolute;
    top: 8px;
    right: 8px;
    font-size: 20px;
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .player-avatar {
    width: 50px;
    height: 50px;
    background: var(--motd-magenta);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 8px;
    font-size: 28px;
  }
  
  .player-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }
  
  .start-game-btn {
    background: linear-gradient(135deg, var(--motd-magenta) 0%, var(--motd-red) 100%);
    color: white;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    letter-spacing: 5px;
    padding: 18px 50px;
    cursor: pointer;
    border-radius: 8px;
    box-shadow: 0 4px 30px rgba(212,20,90,0.5);
    transition: all 0.2s;
  }
  
  .start-game-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 40px rgba(212,20,90,0.7);
  }
  
  .start-game-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* GAME SCREEN */
  .game-screen {
    display: none;
    flex-direction: column;
    flex: 1;
  }
  
  .game-screen.active {
    display: flex;
  }
  
  .question-display {
    background: var(--motd-navy);
    border: 3px solid var(--motd-gold);
    border-radius: 12px;
    padding: 40px;
    margin-bottom: 30px;
    text-align: center;
    min-height: 160px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .question-text {
    font-family: 'Barlow', sans-serif;
    font-size: 36px;
    line-height: 1.4;
    color: var(--text);
  }
  
  .answers-display {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 30px;
  }
  
  .answer-option {
    background: var(--motd-dark-navy);
    border: 3px solid var(--border);
    border-radius: 8px;
    padding: 25px;
    display: flex;
    align-items: center;
    gap: 15px;
    transition: all 0.3s;
  }
  
  .answer-letter {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 42px;
    color: var(--motd-cyan);
    min-width: 50px;
  }
  
  .answer-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 24px;
    font-weight: 600;
    flex: 1;
  }
  
  .answer-count {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: var(--motd-gold);
    min-width: 50px;
    text-align: right;
  }
  
  .answer-option.revealed-correct {
    border-color: var(--motd-cyan);
    background: rgba(77,212,232,0.2);
    animation: correctPulse 0.5s ease;
  }
  
  @keyframes correctPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
  
  .answer-option.revealed-wrong {
    border-color: var(--motd-magenta);
    opacity: 0.4;
  }
  
  /* SCOREBOARD */
  .scoreboard {
    background: var(--motd-navy);
    border: 3px solid var(--motd-gold);
    border-radius: 12px;
    padding: 25px;
    max-height: 300px;
    overflow-y: auto;
  }
  
  .scoreboard-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 4px;
    color: var(--motd-gold);
    text-align: center;
    margin-bottom: 20px;
  }
  
  .score-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .score-item {
    display: flex;
    align-items: center;
    gap: 15px;
    background: var(--motd-dark-navy);
    padding: 15px 20px;
    border-radius: 8px;
    border-left: 4px solid var(--motd-cyan);
  }
  
  .score-rank {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: var(--motd-gold);
    min-width: 45px;
  }
  
  .score-player-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 24px;
    font-weight: 600;
    flex: 1;
  }
  
  .score-points {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    color: var(--motd-cyan);
  }
  
  .host-controls {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 25px;
  }
  
  /* TESTING CONTROLS */
  .testing-controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    z-index: 1000;
  }
  
  .test-btn {
    background: rgba(255,198,41,0.9);
    color: #000;
    border: 2px solid var(--motd-gold);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 16px;
    font-weight: 600;
    padding: 10px 20px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .test-btn:hover {
    background: var(--motd-gold);
    transform: translateY(-2px);
  }
  
  .test-btn.danger {
    background: rgba(212,20,90,0.9);
    border-color: var(--motd-magenta);
    color: white;
  }
  
  .test-btn.danger:hover {
    background: var(--motd-magenta);
  }
  
  .host-btn {
    background: var(--motd-cyan);
    color: #000;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 3px;
    padding: 12px 35px;
    cursor: pointer;
    border-radius: 6px;
    transition: all 0.2s;
  }
  
  .host-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 20px rgba(77,212,232,0.5);
  }
  
  .host-btn.secondary {
    background: var(--motd-magenta);
    color: white;
  }
  
  /* TRANSITION SCREENS */
  .transition-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    text-align: center;
  }
  
  .transition-screen.active {
    display: flex;
  }
  
  .transition-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 72px;
    letter-spacing: 5px;
    color: var(--text);
    text-shadow: 0 0 40px rgba(212,20,90,0.8);
    margin-bottom: 20px;
  }
  
  .transition-subtitle {
    font-family: 'Barlow', sans-serif;
    font-size: 24px;
    color: var(--text-muted);
    margin-bottom: 40px;
  }
  
  .transition-icon {
    font-size: 80px;
    margin-bottom: 30px;
    animation: pulse 1.5s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.08); }
  }
  
  /* ROUND 3 - INTERVIEW */
  .round3-screen {
    display: none;
    flex-direction: column;
    flex: 1;
  }
  
  .round3-screen.active {
    display: flex;
  }
  
  .interview-question-display {
    background: var(--motd-navy);
    border: 3px solid var(--motd-gold);
    border-radius: 12px;
    padding: 40px;
    margin-bottom: 30px;
    text-align: center;
    min-height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .interview-question-text {
    font-family: 'Barlow', sans-serif;
    font-size: 32px;
    line-height: 1.4;
    color: var(--text);
  }
  
  .submitted-answers-display {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 30px;
    max-height: 400px;
    overflow-y: auto;
  }
  
  .submitted-answer-card {
    background: var(--motd-dark-navy);
    border: 3px solid var(--border);
    border-radius: 8px;
    padding: 25px 30px;
    display: flex;
    align-items: center;
    gap: 20px;
    animation: slideIn 0.3s ease;
  }
  
  .answer-player-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 20px;
    font-weight: 600;
    color: var(--motd-cyan);
    min-width: 120px;
  }
  
  .answer-content {
    font-family: 'Barlow', sans-serif;
    font-size: 24px;
    flex: 1;
    color: var(--text);
  }
  
  .answer-votes {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    color: var(--motd-gold);
    min-width: 80px;
    text-align: right;
  }
  
  .answer-votes::after {
    content: ' votes';
    font-size: 16px;
    color: var(--text-muted);
  }
  
  .submitted-answer-card.winner {
    border-color: var(--motd-gold);
    background: rgba(255,198,41,0.1);
    animation: winnerPulse 1s ease infinite;
  }
  
  @keyframes winnerPulse {
    0%, 100% { transform: scale(1); box-shadow: 0 0 0 rgba(255,198,41,0); }
    50% { transform: scale(1.01); box-shadow: 0 0 30px rgba(255,198,41,0.3); }
  }
  
  .hidden {
    display: none !important;
  }
</style>
</head>
<body>

<div class="container">
  <!-- HEADER -->
  <div class="host-header">
    <div class="game-title">Soccer Trophy Quiz Cup</div>
    <div class="header-right">
      <div class="round-indicator" id="round-indicator">Lobby</div>
      <div class="game-code-display">
        <div class="code-label">Game Code</div>
        <div class="code-value" id="game-code">----</div>
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    
    <!-- TEAM SELECTION SCREEN -->
    <div class="team-selection-screen hidden" id="team-selection-screen">
      <div class="team-selection-title">Select Teams</div>
      <div class="team-selection-subtitle">Choose 2 countries to compete</div>
      
      <div class="teams-grid" id="teams-grid"></div>
      
      <div class="selected-teams-display" id="selected-teams-display" style="display: none;">
        <div class="selected-team-card" id="team1-display"></div>
        <div class="vs-text">VS</div>
        <div class="selected-team-card" id="team2-display"></div>
      </div>
      
      <button class="confirm-teams-btn" id="confirm-teams-btn" disabled onclick="confirmTeams()">
        Confirm Teams
      </button>
    </div>

    <!-- LOBBY SCREEN -->
    <div class="lobby-screen" id="lobby-screen">
      <div class="lobby-title">Waiting for Players...</div>
      <div class="lobby-subtitle">Scan QR code or visit URL below</div>
      
      <div class="qr-code-container">
        <div id="qr-code"></div>
      </div>
      
      <div class="join-url" id="join-url">Loading...</div>
      
      <div class="players-waiting">
        <div class="lobby-subtitle" style="text-align: center; margin-bottom: 10px;">
          <span id="player-count">0</span> Players Joined
        </div>
        <div class="lobby-subtitle" style="text-align: center; margin-bottom: 20px; color: var(--motd-gold);">
          First player will control the game
        </div>
        <div class="players-grid" id="players-grid"></div>
      </div>
      
      <button class="start-game-btn" id="select-teams-btn" disabled onclick="showTeamSelection()" style="display: none;">
        Select Teams & Start
      </button>
    </div>

    <!-- GAME SCREEN -->
    <div class="game-screen" id="game-screen">
      <div class="question-display">
        <div class="question-text" id="question-text">Loading question...</div>
      </div>
      
      <div class="answers-display" id="answers-display"></div>
      
      <div class="scoreboard">
        <div class="scoreboard-title">Live Scores</div>
        <div class="score-list" id="score-list"></div>
      </div>
      
      <div class="scoreboard" id="spectator-stats" style="margin-top: 20px; display: none;">
        <div class="scoreboard-title" style="font-size: 18px; color: var(--motd-cyan);">
          ğŸ‘ï¸ Audience Stats
        </div>
        <div id="spectator-count" style="font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text-muted); margin-top: 10px;">
          0 watching
        </div>
        <div id="spectator-votes" style="font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text-muted); margin-top: 5px;">
          0 votes this question
        </div>
      </div>
      
      <div class="host-controls hidden">
        <!-- No buttons needed - first player controls the game -->
      </div>
    </div>

    <!-- TRANSITION SCREENS -->
    <div class="transition-screen" id="transition-screen">
      <div class="transition-icon" id="transition-icon">ğŸ†</div>
      <div class="transition-title" id="transition-title">Round Complete</div>
      <div class="transition-subtitle" id="transition-subtitle">Get ready...</div>
      <button class="host-btn" id="transition-btn" onclick="continueGame()">Continue</button>
    </div>

    <!-- ROUND 3 - INTERVIEW -->
    <div class="round3-screen" id="round3-screen">
      <div class="interview-question-display">
        <div class="interview-question-text" id="round3-question-text">Loading...</div>
      </div>
      
      <div class="submitted-answers-display" id="submitted-answers"></div>
      
      <div class="scoreboard">
        <div class="scoreboard-title">Live Scores</div>
        <div class="score-list" id="round3-score-list"></div>
      </div>
      
      <div class="host-controls">
        <button class="host-btn" id="round3-next-btn" onclick="nextRound3Question()">Next Question â†’</button>
      </div>
    </div>

    <!-- FINAL RESULTS -->
    <div class="transition-screen" id="final-screen">
      <div class="transition-icon">ğŸ‰</div>
      <div class="transition-title">Full Time!</div>
      <div class="transition-subtitle">Final Scores</div>
      <div class="scoreboard" style="max-width: 800px; width: 100%;">
        <div class="scoreboard-title">Winners</div>
        <div class="score-list" id="final-score-list"></div>
      </div>
      <div class="host-controls" style="margin-top: 40px;">
        <button class="host-btn secondary" onclick="location.reload()">New Game</button>
      </div>
    </div>

  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<!-- QR Code Generator - using stable version -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIGURATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig = {
  apiKey: "AIzaSyAHgjTr_l8_dbNeSAmWkTh5NXg94fAh0QQ",
  authDomain: "soccer-quiz-game-cf039.firebaseapp.com",
  databaseURL: "https://soccer-quiz-game-cf039-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "soccer-quiz-game-cf039",
  storageBucket: "soccer-quiz-game-cf039.firebasestorage.app",
  messagingSenderId: "561666470759",
  appId: "1:561666470759:web:036f2dd3ad884a12cef5c2"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME DATA - ALL ROUNDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const ROUND_1_QUESTIONS = [
  {
    question: "Mercenary swords, they are feeble reeds... already the Eagle of Austria has lost its feathers.",
    answers: ["Italy", "Austria", "Germany", "Hong Kong"],
    correct: 0,
    note: "Il Canto degli Italiani â€” written by Goffredo Mameli in 1847."
  },
  {
    question: "To the King of Spain I have always given honour.",
    answers: ["Netherlands", "Spain", "Ireland", "Argentina"],
    correct: 0,
    note: "Het Wilhelmus â€” the oldest national anthem in the world."
  },
  {
    question: "This country's national anthem is famous for having no official lyrics at all. Which nation?",
    answers: ["Spain", "DR Congo", "Bhutan", "Austria"],
    correct: 0,
    note: "La Marcha Real â€” one of only four national anthems with no official lyrics."
  },
  {
    question: "Which one of these was NOT an official World Cup song?",
    answers: ["Balls Balls Balls", "World Cup Willie", "Far Away In America", "Meat Pie, Sausage Roll"],
    correct: 0,
    note: "Balls Balls Balls was never an official World Cup song."
  }
];

// Round 3 - Interview Questions
const ROUND_3_QUESTIONS = [
  {
    question: "The team looked tired. What did you give them at half time?"
  },
  {
    question: "What are you most concerned about in the next round?"
  },
  {
    question: "Is there anything keeping you up at night?"
  }
];

const ROUND_3_ANSWER_POOL = [
  "A hairdryer. Fast and to the head.",
  "A big soapy team bath.",
  "A cheeky Argentinian.",
  "David Seaman's Moustache, cello-taped in exactly the right spot.",
  "The smell of your kit bag, when you forget it over the weekend.",
  "Two feet. Waist height. Maximum velocity.",
  "Didier Drogba's feet in a pasta salad.",
  "One of Gary's Tweets",
  "Little Holes in the back of your socks",
  "A tactical bum flare",
  "Three pigeons in a trench coat",
  "The WiFi password to the away dressing room",
  "A protein shake mixed with grass clippings and regret",
  "A Dido album played on a vuvuzela",
  "An essay to the nation, published in the Sun",
  "Paul Gascoigne, uninvited but inevitably there",
  "A single bead of sweat from Pep's forehead"
];

// World Cup Finals History (countries that reached the final)
const WORLD_CUP_FINALISTS = [
  { name: "Argentina", flag: "ğŸ‡¦ğŸ‡·", color: "#75AADB" },
  { name: "Brazil", flag: "ğŸ‡§ğŸ‡·", color: "#009B3A" },
  { name: "Germany", flag: "ğŸ‡©ğŸ‡ª", color: "#000000" },
  { name: "Italy", flag: "ğŸ‡®ğŸ‡¹", color: "#0066CC" },
  { name: "France", flag: "ğŸ‡«ğŸ‡·", color: "#0055A4" },
  { name: "Vatican City", flag: "ğŸ‡»ğŸ‡¦", color: "#FFE000" },
  { name: "England", flag: "ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿", color: "#C8102E" },
  { name: "Spain", flag: "ğŸ‡ªğŸ‡¸", color: "#C60B1E" },
  { name: "Netherlands", flag: "ğŸ‡³ğŸ‡±", color: "#FF4F00" },
  { name: "Uruguay", flag: "ğŸ‡ºğŸ‡¾", color: "#0038A8" },
  { name: "Croatia", flag: "ğŸ‡­ğŸ‡·", color: "#FF0000" },
  { name: "Czechia", flag: "ğŸ‡¨ğŸ‡¿", color: "#D7141A" },
  { name: "Hungary", flag: "ğŸ‡­ğŸ‡º", color: "#436F4D" },
  { name: "Sweden", flag: "ğŸ‡¸ğŸ‡ª", color: "#006AA7" }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function generateGameCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 4; i++) {
    code += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return code;
}

const gameCode = generateGameCode();
const gameRef = database.ref('games/' + gameCode);

let players = {};
let currentRound = 1;
let currentQuestion = 0;
let gameStarted = false;
let answerRevealed = false;

// Team state
let team1 = null; // {name, flag, color}
let team2 = null;
let teamsSelected = false;

// Sabotage button state
let sabotageActivated = false;
let team1SabotageUsed = false;
let team2SabotageUsed = false;
let leadPlayerId = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INITIALIZE GAME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

document.getElementById('game-code').textContent = gameCode;

const playerUrl = window.location.origin + window.location.pathname.replace('host-complete.html', 'player-complete.html') + '?code=' + gameCode;
document.getElementById('join-url').textContent = playerUrl;

console.log('Player URL:', playerUrl);
console.log('Attempting to generate QR code...');

// Generate QR code - wait for library to load
setTimeout(() => {
  const qrDiv = document.getElementById('qr-code');
  console.log('QR div found:', qrDiv);
  console.log('QRCode library available:', typeof QRCode);
  
  qrDiv.innerHTML = ''; // Clear first
  
  try {
    // Simple QR code generation
    const qr = new QRCode(qrDiv, {
      text: playerUrl,
      width: 220,
      height: 220,
      colorDark: "#000000",
      colorLight: "#ffffff"
    });
    console.log('QR Code generated successfully!');
    
    // Remove duplicate elements after a moment
    setTimeout(() => {
      const children = qrDiv.children;
      if (children.length > 1) {
        // Keep only the first element
        while (children.length > 1) {
          qrDiv.removeChild(children[1]);
        }
        console.log('Removed duplicate QR elements');
      }
    }, 100);
  } catch (error) {
    console.error('QR generation error:', error);
    qrDiv.innerHTML = '<div style="padding: 80px 20px; text-align: center; font-size: 14px; color: #666;">QR Error: ' + error.message + '<br>Use URL below</div>';
  }
}, 1000);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TEAM SELECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Populate team selection grid
const teamsGrid = document.getElementById('teams-grid');
teamsGrid.innerHTML = WORLD_CUP_FINALISTS.map((country, index) => `
  <div class="team-option" id="team-opt-${index}" onclick="selectTeam(${index})">
    <div class="team-flag">${country.flag}</div>
    <div class="team-name">${country.name}</div>
  </div>
`).join('');

function selectTeam(index) {
  const country = WORLD_CUP_FINALISTS[index];
  
  if (!team1) {
    team1 = country;
    document.getElementById('team-opt-' + index).classList.add('selected');
    updateSelectedTeamsDisplay();
  } else if (!team2 && country.name !== team1.name) {
    team2 = country;
    document.getElementById('team-opt-' + index).classList.add('selected');
    updateSelectedTeamsDisplay();
    document.getElementById('confirm-teams-btn').disabled = false;
  } else if (team1 && country.name === team1.name) {
    // Deselect team 1
    team1 = null;
    document.getElementById('team-opt-' + index).classList.remove('selected');
    if (team2) {
      team1 = team2;
      team2 = null;
    }
    updateSelectedTeamsDisplay();
    document.getElementById('confirm-teams-btn').disabled = true;
  } else if (team2 && country.name === team2.name) {
    // Deselect team 2
    team2 = null;
    document.getElementById('team-opt-' + index).classList.remove('selected');
    updateSelectedTeamsDisplay();
    document.getElementById('confirm-teams-btn').disabled = true;
  }
}

function updateSelectedTeamsDisplay() {
  const display = document.getElementById('selected-teams-display');
  
  if (team1 || team2) {
    display.style.display = 'flex';
    
    if (team1) {
      document.getElementById('team1-display').innerHTML = `
        <div class="selected-team-flag">${team1.flag}</div>
        <div class="selected-team-name">${team1.name}</div>
      `;
    }
    
    if (team2) {
      document.getElementById('team2-display').innerHTML = `
        <div class="selected-team-flag">${team2.flag}</div>
        <div class="selected-team-name">${team2.name}</div>
      `;
    }
  } else {
    display.style.display = 'none';
  }
}

function showTeamSelection() {
  // Hide lobby, show "waiting for team selection" message
  document.getElementById('lobby-screen').classList.add('hidden');
  
  // Stop intro_music if playing
  if (window.introMusicAudio) {
    window.introMusicAudio.pause();
    window.introMusicAudio = null;
  }
  
  // Play choose_teams music on host
  console.log('ğŸµ Playing choose_teams.mp3 on host');
  const chooseTeamsAudio = new Audio('choose_teams.mp3');
  chooseTeamsAudio.loop = false;
  chooseTeamsAudio.volume = 0.6;
  chooseTeamsAudio.play()
    .then(() => console.log('ğŸ”Š Playing choose_teams music'))
    .catch(err => console.error('choose_teams play failed:', err));
  window.chooseTeamsAudio = chooseTeamsAudio;
  
  // Show simple waiting screen
  const waitingDiv = document.createElement('div');
  waitingDiv.id = 'team-select-waiting';
  waitingDiv.style.cssText = 'display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; text-align: center;';
  waitingDiv.innerHTML = `
    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 72px; color: var(--text); text-shadow: 0 0 40px rgba(212,20,90,0.8); margin-bottom: 20px; letter-spacing: 5px;">
      Selecting Teams...
    </div>
    <div style="font-family: 'Barlow', sans-serif; font-size: 24px; color: var(--text-muted);">
      Players are choosing their countries
    </div>
    <div class="spinner" style="margin-top: 40px;"></div>
  `;
  
  document.querySelector('.container').appendChild(waitingDiv);
}

function confirmTeams() {
  if (!team1 || !team2) return;
  
  teamsSelected = true;
  
  // Stop intro_music if playing
  if (window.introMusicAudio) {
    window.introMusicAudio.pause();
    window.introMusicAudio = null;
  }
  
  // Stop choose_teams music if playing
  if (window.chooseTeamsAudio) {
    window.chooseTeamsAudio.pause();
    window.chooseTeamsAudio = null;
  }
  
  // Save teams to Firebase
  gameRef.update({
    team1: team1,
    team2: team2,
    teamsSelected: true
  });
  
  // Hide waiting screen
  const waitingDiv = document.getElementById('team-select-waiting');
  if (waitingDiv) waitingDiv.remove();
  
  // Play intro_2 audio first, then dynamic voice
  showRoundIntro();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUND INTRO FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function showRoundIntro() {
  // Hide waiting screen if still visible
  const waitingDiv = document.getElementById('team-select-waiting');
  if (waitingDiv) waitingDiv.remove();
  
  // Play intro_2.mp3 first
  playIntro2Audio();
}

function playIntro2Audio() {
  console.log('ğŸµ Playing intro_2.mp3');
  
  const intro2Audio = new Audio('intro_2.mp3');
  intro2Audio.volume = 0.6;
  
  intro2Audio.addEventListener('canplay', () => {
    console.log('âœ… intro_2.mp3 loaded');
  });
  
  intro2Audio.addEventListener('error', (e) => {
    console.error('âŒ intro_2.mp3 failed to load:', intro2Audio.error);
    // Skip to dynamic voice if intro_2 fails
    generateIntroVoiceDirectly();
  });
  
  intro2Audio.play()
    .then(() => console.log('ğŸ”Š Playing intro_2'))
    .catch(err => {
      console.error('intro_2 play failed:', err);
      generateIntroVoiceDirectly();
    });
  
  // When intro_2 finishes, play dynamic voice (no screen in between)
  intro2Audio.addEventListener('ended', () => {
    console.log('âœ… intro_2 finished, generating dynamic voice');
    generateIntroVoiceDirectly();
  });
}

async function generateIntroVoiceDirectly() {
  const text = `Aye... it's looking like an interesting game. We've got ${team1.name} up against ${team2.name}.`;
  
  console.log('ğŸ™ï¸ Generating intro voice:', text);
  
  // Your ElevenLabs API credentials
  const ELEVENLABS_API_KEY = 'sk_eb4900ceb7e4366087590c2b906743504ba8c844524ddcc4';
  const VOICE_ID = 'rfkTsdZrVWEVhDycUYn9';
  
  try {
    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
      method: 'POST',
      headers: {
        'Accept': 'audio/mpeg',
        'Content-Type': 'application/json',
        'xi-api-key': ELEVENLABS_API_KEY
      },
      body: JSON.stringify({
        text: text,
        model_id: 'eleven_monolingual_v1',
        voice_settings: {
          stability: 0.5,
          similarity_boost: 0.75,
          style: 0.0,
          use_speaker_boost: true
        }
      })
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`ElevenLabs API error: ${response.status} - ${errorText}`);
    }
    
    console.log('âœ… Voice generated successfully');
    
    const audioBlob = await response.blob();
    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = new Audio(audioUrl);
    
    // Play the generated voice
    await audio.play();
    console.log('ğŸ”Š Playing intro voice');
    
    // Wait for audio to finish, then show explainer
    audio.addEventListener('ended', () => {
      console.log('âœ… Intro voice finished, showing explainer');
      showRound1Explainer();
    });
    
    // Fallback if audio doesn't play
    setTimeout(() => {
      if (audio.paused) {
        console.log('âš ï¸ Audio not playing, showing explainer anyway');
        showRound1Explainer();
      }
    }, 15000);
    
  } catch (error) {
    console.error('âŒ ElevenLabs error:', error);
    // Show explainer even if voice fails
    setTimeout(() => {
      showRound1Explainer();
    }, 2000);
  }
}

function showRound1Explainer() {
  // Create explainer screen
  const explainerDiv = document.createElement('div');
  explainerDiv.id = 'round1-explainer';
  explainerDiv.style.cssText = 'position: fixed; inset: 0; background: linear-gradient(135deg, var(--motd-dark-navy) 0%, var(--motd-navy) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; padding: 40px;';
  explainerDiv.innerHTML = `
    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 80px; color: var(--motd-gold); text-shadow: 0 0 40px rgba(255,198,41,0.8); margin-bottom: 40px; letter-spacing: 6px;">
      ROUND 1
    </div>
    
    <div style="font-family: 'Oswald', sans-serif; font-size: 42px; color: var(--text); margin-bottom: 30px; text-transform: uppercase; letter-spacing: 3px;">
      ğŸµ National Anthems ğŸµ
    </div>
    
    <div style="max-width: 800px; text-align: center; margin-bottom: 50px;">
      <p style="font-family: 'Barlow', sans-serif; font-size: 28px; color: var(--text); line-height: 1.6; margin-bottom: 20px;">
        Read the lyrics and guess which national anthem or World Cup song they're from.
      </p>
      <p style="font-family: 'Barlow', sans-serif; font-size: 24px; color: var(--text-muted); line-height: 1.6;">
        Answer correctly to score points for your team!
      </p>
    </div>
    
    <div style="font-family: 'Barlow', sans-serif; font-size: 22px; color: var(--motd-cyan); margin-bottom: 40px;">
      Waiting for first player to start...
    </div>
    
    <div class="spinner"></div>
  `;
  
  document.body.appendChild(explainerDiv);
  
  // Play round_1_intro audio
  console.log('ğŸµ Playing round_1_intro.mp3');
  const round1Audio = new Audio('round_1_intro.mp3');
  round1Audio.volume = 0.6;
  
  round1Audio.addEventListener('error', (e) => {
    console.error('âŒ round_1_intro.mp3 failed to load:', round1Audio.error);
  });
  
  round1Audio.play()
    .then(() => console.log('ğŸ”Š Playing round_1_intro'))
    .catch(err => console.error('round_1_intro play failed:', err));
  
  // Notify players to show explainer on their screens
  gameRef.update({
    showRound1Explainer: true
  });
  
  console.log('ğŸ“± Round 1 explainer shown, waiting for player 1 to start');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME INITIALIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

gameRef.set({
  code: gameCode,
  started: false,
  round: 1,
  currentQuestion: 0,
  teamsSelected: false,
  createdAt: Date.now()
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

gameRef.child('players').on('value', (snapshot) => {
  players = snapshot.val() || {};
  
  // Play intro_music when first player connects
  const playerCount = Object.keys(players).length;
  if (playerCount === 1 && !window.introMusicPlayed) {
    console.log('ğŸµ First player connected, playing intro_music.mp3');
    const introMusic = new Audio('intro_music.mp3');
    introMusic.loop = true;
    introMusic.volume = 0.5;
    introMusic.play()
      .then(() => console.log('ğŸ”Š Playing intro_music'))
      .catch(err => console.error('intro_music play failed:', err));
    window.introMusicPlayed = true;
    window.introMusicAudio = introMusic;
  }
  
  // Enable select teams button if at least 2 players
  const selectTeamsBtn = document.getElementById('select-teams-btn');
  if (selectTeamsBtn) {
    selectTeamsBtn.disabled = playerCount < 2;
  }
  
  // Assign players to teams if teams are selected
  if (teamsSelected && team1 && team2) {
    const playerIds = Object.keys(players);
    playerIds.forEach((playerId, index) => {
      if (!players[playerId].team) {
        // Alternate assignment, keeping teams balanced
        const team1Count = playerIds.filter(id => players[id].team === 1).length;
        const team2Count = playerIds.filter(id => players[id].team === 2).length;
        const assignedTeam = team1Count <= team2Count ? 1 : 2;
        gameRef.child('players/' + playerId).update({ team: assignedTeam });
      }
    });
  }
  
  updatePlayersList();
  updateScoreboard();
});

// Listen for spectators
gameRef.child('spectators').on('value', (snapshot) => {
  const spectators = snapshot.val() || {};
  const spectatorCount = Object.keys(spectators).length;
  
  const spectatorCountEl = document.getElementById('spectator-count');
  if (spectatorCountEl) {
    spectatorCountEl.textContent = `${spectatorCount} watching`;
  }
  
  // Show spectator stats panel if there are spectators
  const spectatorStats = document.getElementById('spectator-stats');
  if (spectatorStats) {
    spectatorStats.style.display = spectatorCount > 0 ? 'block' : 'none';
  }
});

// Listen for spectator votes
gameRef.child('spectatorVotes').on('value', (snapshot) => {
  if (!snapshot.exists() || currentQuestion === undefined) return;
  
  const allVotes = snapshot.val() || {};
  const currentQuestionVotes = allVotes[currentQuestion] || {};
  const voteCount = Object.keys(currentQuestionVotes).length;
  
  const spectatorVotesEl = document.getElementById('spectator-votes');
  if (spectatorVotesEl) {
    spectatorVotesEl.textContent = `${voteCount} votes this question`;
  }
});

// Listen for player 1 ready signal
gameRef.child('readyToSelectTeams').on('value', (snapshot) => {
  console.log('readyToSelectTeams changed:', snapshot.val());
  console.log('teamsSelected:', teamsSelected);
  
  if (snapshot.val() === true && !teamsSelected) {
    console.log('Auto-showing team selection!');
    // Auto-show team selection when player 1 clicks start
    showTeamSelection();
    // Clear the trigger
    gameRef.child('readyToSelectTeams').remove();
  }
});

// Listen for player team selections
gameRef.child('playerTeamSelections').on('value', (snapshot) => {
  const selections = snapshot.val();
  if (selections && selections.player1 && selections.player2) {
    // Both players selected - get the country data
    const team1Country = WORLD_CUP_FINALISTS.find(c => c.name === selections.player1);
    const team2Country = WORLD_CUP_FINALISTS.find(c => c.name === selections.player2);
    
    if (team1Country && team2Country) {
      team1 = team1Country;
      team2 = team2Country;
      confirmTeams();
    }
  }
});

// Listen for game start from lead player (legacy - now handled by confirmTeams)
gameRef.child('started').on('value', (snapshot) => {
  if (snapshot.val() === true && !gameStarted) {
    gameStarted = true;
    // Game start now handled by confirmTeams â†’ generateIntroVoiceDirectly
  }
});

// Listen for player 1 starting Round 1
gameRef.child('round1Started').on('value', (snapshot) => {
  if (snapshot.val() === true) {
    console.log('ğŸ® Player 1 started Round 1');
    const explainerDiv = document.getElementById('round1-explainer');
    if (explainerDiv) {
      explainerDiv.remove();
    }
    startGamePlay();
    gameRef.child('round1Started').remove(); // Clear trigger
  }
});

// Listen for reveal answer command
gameRef.child('revealAnswer').on('value', (snapshot) => {
  if (snapshot.val() === true && !answerRevealed) {
    revealAnswer();
    gameRef.update({ revealAnswer: false });
  }
});

// Listen for next question command
gameRef.child('nextQuestion').on('value', (snapshot) => {
  const nextQ = snapshot.val();
  if (nextQ !== null && nextQ > currentQuestion) {
    nextQuestion();
  }
});

gameRef.child('answers').on('value', (snapshot) => {
  if (gameStarted && !answerRevealed) {
    const answers = snapshot.val() || {};
    updateAnswerCounts(answers);
    
    // Auto-reveal when all players have answered
    const answersForCurrentQ = answers[currentQuestion] || {};
    const answeredCount = Object.keys(answersForCurrentQ).length;
    const totalPlayers = Object.keys(players).length;
    
    if (totalPlayers > 0 && answeredCount === totalPlayers) {
      // All players answered - auto reveal after 1 second
      setTimeout(() => {
        if (!answerRevealed) {
          revealAnswer();
        }
      }, 1000);
    }
  }
});

function updatePlayersList() {
  const grid = document.getElementById('players-grid');
  const count = document.getElementById('player-count');
  
  const playerArray = Object.values(players);
  count.textContent = playerArray.length;
  
  grid.innerHTML = playerArray.map(player => {
    const teamClass = player.team === 1 ? 'team1' : player.team === 2 ? 'team2' : '';
    const teamFlag = player.team === 1 ? team1?.flag : player.team === 2 ? team2?.flag : '';
    
    return `
      <div class="player-card ${teamClass}">
        ${teamFlag ? `<div class="player-team-badge">${teamFlag}</div>` : ''}
        <div class="player-avatar">${player.name.charAt(0).toUpperCase()}</div>
        <div class="player-name">${player.name}</div>
      </div>
    `;
  }).join('');
}

function updateScoreboard() {
  const scoreList = document.getElementById('score-list');
  
  if (!teamsSelected || !team1 || !team2) {
    // Fallback to individual scoring if teams not set
    const playerArray = Object.entries(players).map(([id, player]) => ({
      id,
      name: player.name,
      score: player.score || 0
    }));
    
    playerArray.sort((a, b) => b.score - a.score);
    
    scoreList.innerHTML = playerArray.map((player, index) => `
      <div class="score-item">
        <div class="score-rank">#${index + 1}</div>
        <div class="score-player-name">${player.name}</div>
        <div class="score-points">${player.score}</div>
      </div>
    `).join('');
    return;
  }
  
  // Calculate team scores
  let team1Score = 0;
  let team2Score = 0;
  
  Object.values(players).forEach(player => {
    if (player.team === 1) team1Score += (player.score || 0);
    if (player.team === 2) team2Score += (player.score || 0);
  });
  
  // Display team scores prominently
  scoreList.innerHTML = `
    <div class="score-item" style="border-left: 4px solid var(--motd-cyan); background: rgba(77,212,232,0.1); margin-bottom: 20px;">
      <div class="score-rank">${team1.flag}</div>
      <div class="score-player-name" style="font-size: 28px;">${team1.name}</div>
      <div class="score-points" style="font-size: 42px;">${team1Score}</div>
    </div>
    <div class="score-item" style="border-left: 4px solid var(--motd-magenta); background: rgba(212,20,90,0.1); margin-bottom: 20px;">
      <div class="score-rank">${team2.flag}</div>
      <div class="score-player-name" style="font-size: 28px;">${team2.name}</div>
      <div class="score-points" style="font-size: 42px;">${team2Score}</div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function generateIntroVoiceDirectly() {
  const text = `That's right John... it's looking like an interesting game. We've got ${team1.name} up against ${team2.name}! Certainly one to watch! (given you're already here).`;
  
  console.log('ğŸ™ï¸ Generating intro voice:', text);
  
  // Your ElevenLabs API credentials
  const ELEVENLABS_API_KEY = 'sk_eb4900ceb7e4366087590c2b906743504ba8c844524ddcc4';
  const VOICE_ID = 'rfkTsdZrVWEVhDycUYn9';
  
  try {
    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${VOICE_ID}`, {
      method: 'POST',
      headers: {
        'Accept': 'audio/mpeg',
        'Content-Type': 'application/json',
        'xi-api-key': ELEVENLABS_API_KEY
      },
      body: JSON.stringify({
        text: text,
        model_id: 'eleven_monolingual_v1',
        voice_settings: {
          stability: 0.5,
          similarity_boost: 0.75,
          style: 0.0,
          use_speaker_boost: true
        }
      })
    });
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`ElevenLabs API error: ${response.status} - ${errorText}`);
    }
    
    console.log('âœ… Voice generated successfully');
    
    const audioBlob = await response.blob();
    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = new Audio(audioUrl);
    
    // Play the generated voice
    await audio.play();
    console.log('ğŸ”Š Playing intro voice');
    
    // Wait for audio to finish, then show explainer
    audio.addEventListener('ended', () => {
      console.log('âœ… Intro voice finished, showing explainer');
      showRound1Explainer();
    });
    
    // Fallback if audio doesn't play
    setTimeout(() => {
      if (audio.paused) {
        console.log('âš ï¸ Audio not playing, showing explainer anyway');
        showRound1Explainer();
      }
    }, 15000);
    
  } catch (error) {
    console.error('âŒ ElevenLabs error:', error);
    // Show explainer even if voice fails
    setTimeout(() => {
      showRound1Explainer();
    }, 2000);
  }
}

function showRound1Explainer() {
  // Create explainer screen
  const explainerDiv = document.createElement('div');
  explainerDiv.id = 'round1-explainer';
  explainerDiv.style.cssText = 'position: fixed; inset: 0; background: linear-gradient(135deg, var(--motd-dark-navy) 0%, var(--motd-navy) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; padding: 40px;';
  explainerDiv.innerHTML = `
    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 80px; color: var(--motd-gold); text-shadow: 0 0 40px rgba(255,198,41,0.8); margin-bottom: 40px; letter-spacing: 6px;">
      ROUND 1
    </div>
    
    <div style="font-family: 'Oswald', sans-serif; font-size: 42px; color: var(--text); margin-bottom: 30px; text-transform: uppercase; letter-spacing: 3px;">
      ğŸµ National Anthems ğŸµ
    </div>
    
    <div style="max-width: 800px; text-align: center; margin-bottom: 50px;">
      <p style="font-family: 'Barlow', sans-serif; font-size: 28px; color: var(--text); line-height: 1.6; margin-bottom: 20px;">
        We give you the lyrics, you give us the country
      </p>
      <p style="font-family: 'Barlow', sans-serif; font-size: 24px; color: var(--text-muted); line-height: 1.6;">
        Answer correctly to score points for your team!
      </p>
    </div>
    
    <div style="font-family: 'Barlow', sans-serif; font-size: 22px; color: var(--motd-cyan); margin-bottom: 40px;">
      Waiting for first player to start...
    </div>
    
    <div class="spinner"></div>
  `;
  
  document.body.appendChild(explainerDiv);
  
  // Play round_1_intro audio
  console.log('ğŸµ Attempting to play round_1_intro.mp3');
  const round1Audio = new Audio('round_1_intro.mp3');
  round1Audio.volume = 0.6;
  
  round1Audio.addEventListener('canplay', () => {
    console.log('âœ… round_1_intro.mp3 loaded and ready');
  });
  
  round1Audio.addEventListener('error', (e) => {
    console.error('âŒ round_1_intro.mp3 failed to load:', round1Audio.error);
    console.error('Make sure round_1_intro.mp3 is uploaded to GitHub in the same folder as host-complete.html');
  });
  
  round1Audio.play()
    .then(() => console.log('ğŸ”Š Playing round_1_intro'))
    .catch(err => {
      console.error('âŒ round_1_intro play failed:', err);
      console.log('â„¹ï¸ Game will continue without audio');
    });
  
  // Notify players to show explainer on their screens
  gameRef.update({
    showRound1Explainer: true
  });
  
  console.log('ğŸ“± Round 1 explainer shown, waiting for player 1 to start');
}

function startGamePlay() {
  document.getElementById('lobby-screen').classList.add('hidden');
  document.getElementById('game-screen').classList.add('active');
  document.getElementById('round-indicator').textContent = 'Round 1';
  
  gameRef.update({ started: true, round: 1, currentQuestion: 0 });
  loadQuestion(0);
  
  // Schedule sabotage buttons at random times
  scheduleSabotageButtons();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SABOTAGE BUTTON SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function scheduleSabotageButtons() {
  if (!teamsSelected || !team1 || !team2) return;
  
  // Random time between 15-45 seconds for team 1
  const team1Delay = Math.random() * 30000 + 15000;
  
  // Random time between 15-45 seconds for team 2 (different from team 1)
  const team2Delay = Math.random() * 30000 + 15000;
  
  setTimeout(() => {
    if (!team1SabotageUsed) {
      activateSabotageForTeam(1);
    }
  }, team1Delay);
  
  setTimeout(() => {
    if (!team2SabotageUsed) {
      activateSabotageForTeam(2);
    }
  }, team2Delay);
}

function activateSabotageForTeam(teamNumber) {
  // Pick a random player from this team
  const teamPlayers = Object.entries(players).filter(([id, player]) => player.team === teamNumber);
  
  if (teamPlayers.length === 0) return;
  
  const randomIndex = Math.floor(Math.random() * teamPlayers.length);
  const [selectedPlayerId, selectedPlayer] = teamPlayers[randomIndex];
  
  // Notify this player via Firebase
  gameRef.child('sabotage/' + selectedPlayerId).set({
    active: true,
    timestamp: Date.now(),
    teamNumber: teamNumber
  });
  
  console.log(`Sabotage button activated for ${selectedPlayer.name} (Team ${teamNumber})`);
  
  // Auto-deactivate after 10 seconds
  setTimeout(() => {
    gameRef.child('sabotage/' + selectedPlayerId).remove();
  }, 10000);
}

// Listen for sabotage usage
gameRef.child('sabotageUsed').on('value', (snapshot) => {
  const sabotageData = snapshot.val();
  if (sabotageData) {
    const { userId, targetTeam } = sabotageData;
    
    // Deduct 5 points from target team
    Object.entries(players).forEach(([playerId, player]) => {
      if (player.team === targetTeam) {
        const currentScore = player.score || 0;
        const newScore = Math.max(0, currentScore - 5); // Don't go below 0
        gameRef.child('players/' + playerId).update({ score: newScore });
      }
    });
    
    // Mark as used
    gameRef.child('players/' + userId).once('value', (snap) => {
      const userTeam = snap.val()?.team;
      if (userTeam === 1) team1SabotageUsed = true;
      if (userTeam === 2) team2SabotageUsed = true;
    });
    
    // Clear the trigger
    gameRef.child('sabotageUsed').remove();
    
    updateScoreboard();
  }
});

function loadQuestion(index) {
  const q = ROUND_1_QUESTIONS[index];
  answerRevealed = false;
  
  document.getElementById('question-text').textContent = q.question;
  
  const answersDisplay = document.getElementById('answers-display');
  const letters = ['A', 'B', 'C', 'D'];
  
  answersDisplay.innerHTML = q.answers.map((answer, i) => `
    <div class="answer-option" id="answer-${i}">
      <div class="answer-letter">${letters[i]}</div>
      <div class="answer-text">${answer}</div>
      <div class="answer-count" id="count-${i}">0</div>
    </div>
  `).join('');
  
  gameRef.update({ currentQuestion: index });
  gameRef.child('answers/' + index).remove();
  
  // Play question audio
  const questionAudio = new Audio(`question${index + 1}.mp3`);
  console.log(`Attempting to play question${index + 1}.mp3...`);
  
  questionAudio.addEventListener('error', (e) => {
    console.error(`Question ${index + 1} audio failed to load:`, questionAudio.error);
  });
  
  questionAudio.play()
    .then(() => console.log(`Question ${index + 1} audio playing`))
    .catch(err => console.error('Question audio play failed:', err));
  
  // Store reference to stop if needed
  window.currentQuestionAudio = questionAudio;
}

function updateAnswerCounts(answers) {
  const counts = [0, 0, 0, 0];
  Object.values(answers).forEach(answer => {
    if (answer.answerIndex !== undefined) {
      counts[answer.answerIndex]++;
    }
  });
  
  counts.forEach((count, i) => {
    const el = document.getElementById('count-' + i);
    if (el) el.textContent = count;
  });
}

function revealAnswer() {
  answerRevealed = true;
  const q = ROUND_1_QUESTIONS[currentQuestion];
  
  // Stop question audio if still playing
  if (window.currentQuestionAudio) {
    window.currentQuestionAudio.pause();
    window.currentQuestionAudio = null;
  }
  
  for (let i = 0; i < q.answers.length; i++) {
    const el = document.getElementById('answer-' + i);
    if (i === q.correct) {
      el.classList.add('revealed-correct');
    } else {
      el.classList.add('revealed-wrong');
    }
  }
  
  // Award points
  gameRef.child('answers/' + currentQuestion).once('value', (snapshot) => {
    const answers = snapshot.val() || {};
    Object.entries(answers).forEach(([playerId, answer]) => {
      if (answer.answerIndex === q.correct) {
        const currentScore = players[playerId]?.score || 0;
        gameRef.child('players/' + playerId).update({ score: currentScore + 1 });
      }
    });
  });
  
  // Play answer audio
  const answerAudio = new Audio(`answer${currentQuestion + 1}.mp3`);
  console.log(`Attempting to play answer${currentQuestion + 1}.mp3...`);
  
  answerAudio.addEventListener('error', (e) => {
    console.error(`Answer ${currentQuestion + 1} audio failed to load:`, answerAudio.error);
  });
  
  answerAudio.play()
    .then(() => console.log(`Answer ${currentQuestion + 1} audio playing`))
    .catch(err => console.error('Answer audio play failed:', err));
  
  // Auto-advance to next question when audio ends
  answerAudio.addEventListener('ended', () => {
    setTimeout(() => {
      nextQuestion();
    }, 1500); // 1.5 second pause after audio before next question
  });
  
  // Fallback in case audio doesn't play or load
  setTimeout(() => {
    if (!answerAudio.ended && answerAudio.paused) {
      console.log('Audio not playing, auto-advancing anyway');
      nextQuestion();
    }
  }, 8000); // 8 second max wait
}

function nextQuestion() {
  currentQuestion++;
  if (currentQuestion < ROUND_1_QUESTIONS.length) {
    loadQuestion(currentQuestion);
    answerRevealed = false;
  } else {
    // Round 1 complete, move to Round 3 (Interview)
    startRound3();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ROUND 3 - INTERVIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let round3CurrentQ = 0;

function startRound3() {
  document.getElementById('game-screen').classList.remove('active');
  document.getElementById('round3-screen').classList.add('active');
  document.getElementById('round-indicator').textContent = 'Round 3 - Interview';
  
  round3CurrentQ = 0;
  gameRef.update({ round: 3, currentRound3Question: 0 });
  loadRound3Question(0);
}

function loadRound3Question(index) {
  const q = ROUND_3_QUESTIONS[index];
  document.getElementById('round3-question-text').textContent = q.question;
  document.getElementById('submitted-answers').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Waiting for players to submit answers...</div>';
  
  // Clear previous Round 3 data
  gameRef.child('round3/' + index).remove();
  gameRef.update({ currentRound3Question: index });
  
  // Give each player 4 random answer options from the pool
  const playerIds = Object.keys(players);
  playerIds.forEach(playerId => {
    // Shuffle and pick 4 random answers
    const shuffled = [...ROUND_3_ANSWER_POOL].sort(() => Math.random() - 0.5);
    const playerOptions = shuffled.slice(0, 4);
    gameRef.child('round3/' + index + '/playerOptions/' + playerId).set(playerOptions);
  });
  
  // Listen for submitted answers
  gameRef.child('round3/' + index + '/submissions').on('value', (snapshot) => {
    displaySubmittedAnswers(snapshot.val() || {}, index);
  });
  
  // Listen for votes and award points
  gameRef.child('round3/' + index + '/votes').on('value', (voteSnapshot) => {
    const votes = voteSnapshot.val() || {};
    awardRound3Points(votes, index);
  });
}

function displaySubmittedAnswers(submissions, questionIndex) {
  const submissionsDiv = document.getElementById('submitted-answers');
  const submissionArray = Object.entries(submissions).map(([playerId, data]) => ({
    playerId,
    playerName: players[playerId]?.name || 'Unknown',
    answer: data.answer,
    votes: data.votes || 0
  }));
  
  if (submissionArray.length === 0) {
    submissionsDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Waiting for players to submit answers...</div>';
    return;
  }
  
  // Sort by votes
  submissionArray.sort((a, b) => b.votes - a.votes);
  
  submissionsDiv.innerHTML = submissionArray.map((sub, index) => {
    const isWinner = index === 0 && sub.votes > 0;
    return `
      <div class="submitted-answer-card ${isWinner ? 'winner' : ''}">
        <div class="answer-player-name">${sub.playerName}</div>
        <div class="answer-content">${sub.answer}</div>
        <div class="answer-votes">${sub.votes}</div>
      </div>
    `;
  }).join('');
  
  // Update scoreboard with Round 3 scores
  updateRound3Scoreboard();
}

function updateRound3Scoreboard() {
  const scoreList = document.getElementById('round3-score-list');
  
  if (!teamsSelected || !team1 || !team2) {
    // Individual scoring fallback
    const playerArray = Object.entries(players).map(([id, player]) => ({
      id,
      name: player.name,
      score: player.score || 0
    }));
    
    playerArray.sort((a, b) => b.score - a.score);
    
    scoreList.innerHTML = playerArray.map((player, index) => `
      <div class="score-item">
        <div class="score-rank">#${index + 1}</div>
        <div class="score-player-name">${player.name}</div>
        <div class="score-points">${player.score}</div>
      </div>
    `).join('');
    return;
  }
  
  // Calculate team scores
  let team1Score = 0;
  let team2Score = 0;
  
  Object.values(players).forEach(player => {
    if (player.team === 1) team1Score += (player.score || 0);
    if (player.team === 2) team2Score += (player.score || 0);
  });
  
  // Display team scores
  scoreList.innerHTML = `
    <div class="score-item" style="border-left: 4px solid var(--motd-cyan); background: rgba(77,212,232,0.1);">
      <div class="score-rank">${team1.flag}</div>
      <div class="score-player-name" style="font-size: 24px;">${team1.name}</div>
      <div class="score-points" style="font-size: 36px;">${team1Score}</div>
    </div>
    <div class="score-item" style="border-left: 4px solid var(--motd-magenta); background: rgba(212,20,90,0.1);">
      <div class="score-rank">${team2.flag}</div>
      <div class="score-player-name" style="font-size: 24px;">${team2.name}</div>
      <div class="score-points" style="font-size: 36px;">${team2Score}</div>
    </div>
  `;
}

function awardRound3Points(votes, questionIndex) {
  // Count votes for each player
  const voteCounts = {};
  Object.values(votes).forEach(targetPlayerId => {
    voteCounts[targetPlayerId] = (voteCounts[targetPlayerId] || 0) + 1;
  });
  
  // Find winner (most votes)
  let winnerId = null;
  let maxVotes = 0;
  Object.entries(voteCounts).forEach(([playerId, count]) => {
    if (count > maxVotes) {
      maxVotes = count;
      winnerId = playerId;
    }
  });
  
  // Award bonus points to winner (3 points for winning)
  if (winnerId && maxVotes > 0) {
    gameRef.child('players/' + winnerId + '/score').once('value', (snap) => {
      const currentScore = snap.val() || 0;
      gameRef.child('players/' + winnerId + '/score').set(currentScore + 3);
    });
  }
}

function nextRound3Question() {
  round3CurrentQ++;
  if (round3CurrentQ < ROUND_3_QUESTIONS.length) {
    loadRound3Question(round3CurrentQ);
  } else {
    // Round 3 complete, show final results
    document.getElementById('round3-screen').classList.remove('active');
    showFinalScreen();
  }
}

function showFinalScreen() {
  document.getElementById('game-screen').classList.remove('active');
  document.getElementById('final-screen').classList.add('active');
  document.getElementById('round-indicator').textContent = 'Full Time';
  
  const finalScoreList = document.getElementById('final-score-list');
  
  if (!teamsSelected || !team1 || !team2) {
    // Individual scores fallback
    const playerArray = Object.entries(players).map(([id, player]) => ({
      id,
      name: player.name,
      score: player.score || 0
    }));
    
    playerArray.sort((a, b) => b.score - a.score);
    
    finalScoreList.innerHTML = playerArray.map((player, index) => {
      let medal = '';
      if (index === 0) medal = 'ğŸ¥‡';
      else if (index === 1) medal = 'ğŸ¥ˆ';
      else if (index === 2) medal = 'ğŸ¥‰';
      
      return `
        <div class="score-item">
          <div class="score-rank">${medal || '#' + (index + 1)}</div>
          <div class="score-player-name">${player.name}</div>
          <div class="score-points">${player.score}</div>
        </div>
      `;
    }).join('');
    return;
  }
  
  // Calculate final team scores
  let team1Score = 0;
  let team2Score = 0;
  const team1Players = [];
  const team2Players = [];
  
  Object.entries(players).forEach(([id, player]) => {
    if (player.team === 1) {
      team1Score += (player.score || 0);
      team1Players.push({ name: player.name, score: player.score || 0 });
    }
    if (player.team === 2) {
      team2Score += (player.score || 0);
      team2Players.push({ name: player.name, score: player.score || 0 });
    }
  });
  
  const winner = team1Score > team2Score ? team1 : team2Score > team1Score ? team2 : null;
  const winnerScore = team1Score > team2Score ? team1Score : team2Score;
  const loser = winner === team1 ? team2 : team1;
  const loserScore = winner === team1 ? team2Score : team1Score;
  
  finalScoreList.innerHTML = `
    <div style="text-align: center; margin-bottom: 40px;">
      <div style="font-family: 'Bebas Neue', sans-serif; font-size: 64px; color: var(--motd-gold); margin-bottom: 20px;">
        ${winner ? winner.flag + ' ' + winner.name + ' Wins!' : 'Draw!'}
      </div>
      <div style="font-family: 'Barlow', sans-serif; font-size: 28px; color: var(--text-muted);">
        ${winner ? winnerScore + ' - ' + loserScore : team1Score + ' - ' + team2Score}
      </div>
    </div>
    
    <div class="score-item" style="border-left: 4px solid ${winner === team1 ? 'var(--motd-gold)' : 'var(--motd-cyan)'}; background: ${winner === team1 ? 'rgba(255,198,41,0.2)' : 'rgba(77,212,232,0.1)'}; margin-bottom: 15px;">
      <div class="score-rank">${team1.flag}</div>
      <div class="score-player-name" style="font-size: 28px;">${team1.name}</div>
      <div class="score-points" style="font-size: 42px;">${team1Score}</div>
    </div>
    
    <div class="score-item" style="border-left: 4px solid ${winner === team2 ? 'var(--motd-gold)' : 'var(--motd-magenta)'}; background: ${winner === team2 ? 'rgba(255,198,41,0.2)' : 'rgba(212,20,90,0.1)'};">
      <div class="score-rank">${team2.flag}</div>
      <div class="score-player-name" style="font-size: 28px;">${team2.name}</div>
      <div class="score-points" style="font-size: 42px;">${team2Score}</div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
/*
  This is a SIMPLIFIED multiplayer version with Round 1 only.
  
  For the FULL experience with all audio/video features:
  - Karaoke bonus round
  - Commentary video recording
  - Interview questions
  
  Use the single-player version (gaffers-chair.html) instead.
  
  Multiplayer works best for the core quiz questions where players
  answer on their phones and see results live on TV.
*/

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TESTING FUNCTIONS (REMOVE WHEN FINISHED)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function testSkipQuestion() {
  if (currentRound === 1) {
    // Skip to next Round 1 question
    currentQuestion++;
    if (currentQuestion < ROUND_1_QUESTIONS.length) {
      loadQuestion(currentQuestion);
      answerRevealed = false;
    } else {
      startRound3();
    }
  } else if (currentRound === 3) {
    // Skip to next Round 3 question
    round3CurrentQ++;
    if (round3CurrentQ < ROUND_3_QUESTIONS.length) {
      loadRound3Question(round3CurrentQ);
    } else {
      showFinalScreen();
    }
  }
}

function testSkipToRound3() {
  currentRound = 3;
  round3CurrentQ = -1;
  startRound3();
}

function testTriggerSabotage(teamNumber) {
  if (!teamsSelected) {
    alert('Teams must be selected first!');
    return;
  }
  activateSabotageForTeam(teamNumber);
  alert(`Sabotage button activated for Team ${teamNumber}`);
}

function testResetGame() {
  if (confirm('Reset entire game? This will clear all data.')) {
    location.reload();
  }
}

</script>

<!-- TESTING CONTROLS (REMOVE WHEN FINISHED) -->
<div class="testing-controls">
  <button class="test-btn" onclick="testSkipQuestion()">â­ï¸ Next Question</button>
  <button class="test-btn" onclick="testSkipToRound3()">ğŸ¤ Skip to Round 3</button>
  <button class="test-btn" onclick="testTriggerSabotage(1)">ğŸ’£ Sabotage Team 1</button>
  <button class="test-btn" onclick="testTriggerSabotage(2)">ğŸ’£ Sabotage Team 2</button>
  <button class="test-btn danger" onclick="testResetGame()">ğŸ”„ Reset Game</button>
</div>

</body>
</html>

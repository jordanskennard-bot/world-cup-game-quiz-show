
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Quiz Player - Mobile</title>
<!-- VERSION: 3.0 - Fixed gameRef null issue -->
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:ital,wght@0,400;0,600;0,700;1,400&family=Barlow:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

<!-- 
  FIREBASE SETUP REQUIRED
  Replace the firebaseConfig below with YOUR EXACT SAME CONFIG from host-complete.html
-->

<style>
  :root {
    --motd-magenta: #d4145a;
    --motd-red: #c81e5b;
    --motd-navy: #2c3e69;
    --motd-dark-navy: #1a2540;
    --motd-cyan: #4dd4e8;
    --motd-gold: #ffc629;
    --text: #ffffff;
    --text-muted: #a8b4d0;
    --border: #3e5c8f;
  }
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: 'Barlow', sans-serif;
    background: linear-gradient(135deg, var(--motd-dark-navy) 0%, var(--motd-navy) 100%);
    color: var(--text);
    min-height: 100vh;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
  }
  
  .container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }
  
  /* JOIN SCREEN */
  .join-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
  }
  
  .join-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    letter-spacing: 3px;
    color: var(--text);
    text-shadow: 0 0 30px rgba(212,20,90,0.8);
    margin-bottom: 10px;
    text-align: center;
  }
  
  .join-subtitle {
    font-family: 'Barlow', sans-serif;
    font-size: 16px;
    color: var(--text-muted);
    margin-bottom: 40px;
    text-align: center;
  }
  
  .join-form {
    width: 100%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .input-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
  }
  
  .input-field {
    background: var(--motd-navy);
    border: 2px solid var(--border);
    color: var(--text);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 20px;
    font-weight: 600;
    padding: 16px;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 4px;
    text-align: center;
  }
  
  .input-field:focus {
    outline: none;
    border-color: var(--motd-cyan);
  }
  
  .input-field.name-input {
    text-transform: none;
    letter-spacing: 1px;
  }
  
  .join-btn {
    background: linear-gradient(135deg, var(--motd-magenta) 0%, var(--motd-red) 100%);
    color: white;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 4px;
    padding: 18px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(212,20,90,0.5);
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  
  .join-btn:active {
    transform: translateY(2px);
  }
  
  .error-message {
    background: var(--motd-magenta);
    color: white;
    padding: 12px;
    border-radius: 6px;
    font-size: 14px;
    text-align: center;
    display: none;
  }
  
  .error-message.show {
    display: block;
    animation: shake 0.3s ease;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
  }
  
  /* WAITING SCREEN */
  .waiting-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    text-align: center;
  }
  
  .waiting-screen.active {
    display: flex;
  }
  
  .waiting-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 3px;
    color: var(--motd-cyan);
    margin-bottom: 20px;
  }
  
  .waiting-message {
    font-family: 'Barlow', sans-serif;
    font-size: 18px;
    color: var(--text-muted);
    margin-bottom: 40px;
  }
  
  .player-info {
    background: var(--motd-navy);
    border: 2px solid var(--motd-cyan);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .player-info-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }
  
  .player-info-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    letter-spacing: 3px;
    color: var(--motd-cyan);
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border);
    border-top-color: var(--motd-cyan);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* GAME SCREEN */
  .game-screen {
    display: none;
    flex-direction: column;
    flex: 1;
  }
  
  .game-screen.active {
    display: flex;
  }
  
  .player-header {
    background: var(--motd-navy);
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
  }
  
  .player-team-badge {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--motd-gold);
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  
  .player-name-display {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    font-weight: 600;
  }
  
  .player-score-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: var(--motd-cyan);
  }
  
  .question-prompt {
    background: var(--motd-navy);
    border: 3px solid var(--motd-gold);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .question-prompt-text {
    font-family: 'Barlow', sans-serif;
    font-size: 18px;
    line-height: 1.5;
    color: var(--text);
  }
  
  .answer-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
  }
  
  .answer-btn {
    background: var(--motd-dark-navy);
    border: 3px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  
  .answer-btn:active:not(.disabled) {
    transform: scale(0.98);
  }
  
  .answer-btn-letter {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: var(--motd-cyan);
    min-width: 40px;
  }
  
  .answer-btn-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    font-weight: 600;
    flex: 1;
    color: var(--text);
  }
  
  .answer-btn.selected {
    border-color: var(--motd-cyan);
    background: rgba(77,212,232,0.2);
    animation: pulse 0.3s ease;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
  
  .answer-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .status-message {
    background: var(--motd-navy);
    border: 2px solid var(--motd-cyan);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    margin-top: 20px;
  }
  
  .status-message-text {
    font-family: 'Barlow', sans-serif;
    font-size: 16px;
    color: var(--motd-cyan);
  }
  
  .status-icon {
    font-size: 32px;
    margin-bottom: 10px;
  }
  
  /* SABOTAGE BUTTON */
  .sabotage-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
  }
  
  .sabotage-overlay.active {
    display: flex;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .sabotage-container {
    text-align: center;
    animation: zoomIn 0.3s ease;
  }
  
  @keyframes zoomIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  
  .sabotage-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    color: var(--motd-magenta);
    text-shadow: 0 0 30px rgba(212,20,90,0.8);
    margin-bottom: 20px;
    letter-spacing: 3px;
  }
  
  .sabotage-subtitle {
    font-family: 'Barlow', sans-serif;
    font-size: 20px;
    color: var(--text-muted);
    margin-bottom: 30px;
  }
  
  .sabotage-timer {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 64px;
    color: var(--motd-gold);
    margin-bottom: 30px;
    text-shadow: 0 0 20px rgba(255,198,41,0.6);
  }
  
  .sabotage-btn {
    background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
    color: white;
    border: 3px solid var(--motd-gold);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 42px;
    letter-spacing: 5px;
    padding: 30px 60px;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 8px 40px rgba(255,0,0,0.6);
    transition: all 0.2s;
    animation: pulse 1s ease-in-out infinite;
    -webkit-tap-highlight-color: transparent;
  }
  
  .sabotage-btn:active {
    transform: scale(0.95);
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 8px 40px rgba(255,0,0,0.6); }
    50% { transform: scale(1.05); box-shadow: 0 12px 60px rgba(255,0,0,0.9); }
  }
  
  .sabotage-warning {
    font-family: 'Barlow', sans-serif;
    font-size: 14px;
    color: var(--motd-magenta);
    margin-top: 20px;
    font-style: italic;
  }
  
  /* LEAD PLAYER CONTROLS */
  .lead-controls {
    display: none;
    gap: 10px;
    margin-top: 20px;
  }
  
  .lead-controls.visible {
    display: flex;
  }
  
  .lead-btn {
    flex: 1;
    background: var(--motd-gold);
    color: #000;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 3px;
    padding: 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .lead-btn:active {
    transform: scale(0.98);
  }
  
  .lead-btn.primary {
    background: linear-gradient(135deg, var(--motd-magenta) 0%, var(--motd-red) 100%);
    color: white;
  }
  
  .lead-badge {
    background: var(--motd-gold);
    color: #000;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 14px;
    letter-spacing: 2px;
    padding: 6px 12px;
    border-radius: 6px;
    display: inline-block;
    margin-left: 8px;
  }
  
  /* ROUND 3 - VOTING */
  .voting-screen {
    display: none;
    flex-direction: column;
    flex: 1;
  }
  
  .voting-screen.active {
    display: flex;
  }
  
  .voting-header {
    background: var(--motd-navy);
    border: 2px solid var(--motd-gold);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .voting-header-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: var(--motd-gold);
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  
  .vote-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
    overflow-y: auto;
  }
  
  .vote-btn {
    background: var(--motd-dark-navy);
    border: 3px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  
  .vote-btn:active:not(.disabled):not(.voted):not(.own-answer) {
    transform: scale(0.98);
  }
  
  .vote-player-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--motd-cyan);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .vote-answer-text {
    font-family: 'Barlow', sans-serif;
    font-size: 18px;
    line-height: 1.4;
    color: var(--text);
  }
  
  .vote-btn.voted {
    border-color: var(--motd-gold);
    background: rgba(255,198,41,0.15);
  }
  
  .vote-btn.own-answer {
    opacity: 0.5;
    cursor: not-allowed;
    border-style: dashed;
  }
  
  .vote-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .hidden {
    display: none !important;
  }
</style>
</head>
<body>

<div class="container">
  
  <!-- JOIN SCREEN -->
  <div class="join-screen" id="join-screen">
    <div class="join-title">Join Game</div>
    <div class="join-subtitle">Enter your details to play</div>
    
    <form class="join-form" onsubmit="joinGame(event)">
      <div class="input-group">
        <label class="input-label">Game Code</label>
        <input type="text" class="input-field" id="code-input" maxlength="4" placeholder="XXXX" required autocomplete="off">
      </div>
      
      <div class="input-group">
        <label class="input-label">Your Name</label>
        <input type="text" class="input-field name-input" id="name-input" maxlength="20" placeholder="Enter name" required autocomplete="off">
      </div>
      
      <div class="error-message" id="error-message"></div>
      
      <button type="submit" class="join-btn">Join Game</button>
    </form>
  </div>

  <!-- WAITING SCREEN -->
  <div class="waiting-screen" id="waiting-screen">
    <div class="waiting-title">You're In!</div>
    <div class="waiting-message" id="waiting-message">Waiting for host to start the game...</div>
    
    <div class="player-info">
      <div class="player-info-label">Your Name</div>
      <div class="player-info-value" id="waiting-name"></div>
    </div>
    
    <div class="player-info">
      <div class="player-info-label">Game Code</div>
      <div class="player-info-value" id="waiting-code"></div>
    </div>
    
    <div class="lead-controls" id="waiting-lead-controls">
      <button class="lead-btn primary" onclick="startGameAsLead()">üéÆ Start Game</button>
    </div>
    
    <div class="spinner" id="waiting-spinner"></div>
  </div>

  <!-- GAME SCREEN -->
  <div class="game-screen" id="game-screen">
    <div class="player-header">
      <div class="player-team-badge" id="player-team-badge" style="display: none;"></div>
      <div>
        <span class="player-name-display" id="player-name-header"></span>
      </div>
      <div class="player-score-display"><span id="player-score">0</span> pts</div>
    </div>
    
    <div class="question-prompt">
      <div class="question-prompt-text" id="question-text">Loading...</div>
    </div>
    
    <div class="answer-options" id="answer-options"></div>
    
    <div class="status-message hidden" id="status-message">
      <div class="status-icon" id="status-icon">‚úì</div>
      <div class="status-message-text" id="status-text"></div>
    </div>
    
    <div class="lead-controls" id="game-lead-controls">
      <button class="lead-btn" id="reveal-lead-btn" onclick="revealAnswerAsLead()">Reveal Answer</button>
      <button class="lead-btn primary" id="next-lead-btn" onclick="nextQuestionAsLead()">Next ‚Üí</button>
    </div>
  </div>

  <!-- ROUND 3 - VOTING SCREEN -->
  <div class="voting-screen" id="voting-screen">
    <div class="player-header">
      <div class="player-team-badge" id="voting-team-badge" style="display: none;"></div>
      <div class="player-name-display" id="voting-player-name"></div>
      <div class="player-score-display"><span id="voting-score">0</span> pts</div>
    </div>
    
    <div class="voting-header">
      <div class="voting-header-text" id="voting-header-text">Vote for the best answer!</div>
    </div>
    
    <div class="vote-options" id="vote-options"></div>
    
    <div class="status-message hidden" id="voting-status">
      <div class="status-icon" id="voting-status-icon">‚úì</div>
      <div class="status-message-text" id="voting-status-text"></div>
    </div>
  </div>

  <!-- SABOTAGE BUTTON OVERLAY -->
  <div class="sabotage-overlay" id="sabotage-overlay">
    <div class="sabotage-container">
      <div class="sabotage-title">‚ö†Ô∏è SECRET WEAPON ‚ö†Ô∏è</div>
      <div class="sabotage-subtitle">Steal 5 points from the other team!</div>
      <div class="sabotage-timer" id="sabotage-timer">10</div>
      <button class="sabotage-btn" onclick="useSabotage()">
        üí£ SABOTAGE üí£
      </button>
      <div class="sabotage-warning">Only you can see this! Use it wisely...</div>
    </div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyAHgjTr_l8_dbNeSAmWkTh5NXg94fAh0QQ",
  authDomain: "soccer-quiz-game-cf039.firebaseapp.com",
  databaseURL: "https://soccer-quiz-game-cf039-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "soccer-quiz-game-cf039",
  storageBucket: "soccer-quiz-game-cf039.firebasestorage.app",
  messagingSenderId: "561666470759",
  appId: "1:561666470759:web:036f2dd3ad884a12cef5c2"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME DATA - MUST MATCH HOST EXACTLY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const ROUND_1_QUESTIONS = [
  {
    question: "Mercenary swords, they are feeble reeds... already the Eagle of Austria has lost its feathers.",
    answers: ["Italy", "Austria", "Germany", "Hong Kong"]
  },
  {
    question: "To the King of Spain I have always given honour.",
    answers: ["Netherlands", "Spain", "Ireland", "Argentina"]
  },
  {
    question: "This country's national anthem is famous for having no official lyrics at all. Which nation?",
    answers: ["Spain", "DR Congo", "Bhutan", "Austria"]
  },
  {
    question: "Which one of these was NOT an official World Cup song?",
    answers: ["Balls Balls Balls", "World Cup Willie", "Far Away In America", "Meat Pie, Sausage Roll"]
  }
];

// Round 3 - Interview Questions
const ROUND_3_QUESTIONS = [
  {
    question: "The team looked tired. What did you give them at half time?"
  },
  {
    question: "What are you most concerned about in the next round?"
  },
  {
    question: "Is there anything keeping you up at night?"
  }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let gameCode = '';
let playerName = '';
let playerId = '';
let gameRef = null;
let currentScore = 0;
let currentQuestionIndex = -1;
let currentRound = 1;
let round3CurrentQ = -1;
let myRound3Answers = {};
let sabotageTimer = null;
let sabotageTimeLeft = 10;
let players = {}; // For Round 3 voting
let isLeadPlayer = false;

// Check if code is in URL
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('code')) {
  document.getElementById('code-input').value = urlParams.get('code');
}

// Auto-focus code input
document.getElementById('code-input').focus();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JOIN GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function joinGame(event) {
  alert('Function called!');
  event.preventDefault();
  console.log('Join clicked');
  
  gameCode = document.getElementById('code-input').value.toUpperCase().trim();
  playerName = document.getElementById('name-input').value.trim();
  
  if (!gameCode || !playerName) {
    alert('Please enter code and name');
    return;
  }
  
  gameRef = database.ref('games/' + gameCode);
  gameRef.once('value').then((snapshot) => {
    if (!snapshot.exists()) {
      alert('Game not found');
      throw new Error('Game not found');
    }
    
    playerId = 'player_' + Date.now();
    return gameRef.child('players/' + playerId).set({
      name: playerName,
      score: 0,
      joinedAt: Date.now()
    });
  }).then(() => {
    document.getElementById('join-screen').classList.add('hidden');
    document.getElementById('waiting-screen').classList.add('active');
    document.getElementById('waiting-name').textContent = playerName;
    document.getElementById('waiting-code').textContent = gameCode;
    listenForGameStart();
  }).catch((error) => {
    console.error('Join error:', error);
    if (error.message !== 'Game not found') {
      alert('Error: ' + error.message);
    }
  });
}

function showError(message) {
  const errorEl = document.getElementById('error-message');
  errorEl.textContent = message;
  errorEl.classList.add('show');
  setTimeout(() => errorEl.classList.remove('show'), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME LISTENERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function listenForGameStart() {
  console.log('listenForGameStart called');
  console.log('gameRef:', gameRef);
  console.log('playerId:', playerId);
  
  if (!gameRef) {
    console.error('ERROR: gameRef is null!');
    alert('Internal error: Game reference not set');
    return;
  }
  
  // Check if this is the first player
  gameRef.child('players').once('value', (snapshot) => {
    const players = snapshot.val() || {};
    const playerIds = Object.keys(players);
    const isFirstPlayer = playerIds.length > 0 && playerIds[0] === playerId;
    
    console.log('Player IDs:', playerIds);
    console.log('My player ID:', playerId);
    console.log('Is first player:', isFirstPlayer);
    
    if (isFirstPlayer) {
      // Show start button for first player
      document.getElementById('waiting-message').textContent = 'You joined first! Select teams and start when ready.';
      const leadControls = document.getElementById('waiting-lead-controls');
      leadControls.style.display = 'flex';
      leadControls.style.justifyContent = 'center';
      document.getElementById('waiting-spinner').style.display = 'none';
      console.log('Start button shown for first player');
    }
  });
  
  // Listen for team assignment
  gameRef.child('players/' + playerId + '/team').on('value', (snapshot) => {
    const teamNumber = snapshot.val();
    if (teamNumber) {
      // Get team info
      gameRef.child('team' + teamNumber).once('value', (teamSnapshot) => {
        const teamInfo = teamSnapshot.val();
        if (teamInfo) {
          // Update waiting screen with team info
          const teamDisplay = document.createElement('div');
          teamDisplay.className = 'player-info';
          teamDisplay.style.cssText = 'border-color: ' + (teamNumber === 1 ? '#4dd4e8' : '#d4145a');
          teamDisplay.innerHTML = `
            <div class="player-info-label">Your Team</div>
            <div class="player-info-value">${teamInfo.flag} ${teamInfo.name}</div>
          `;
          
          const waitingCode = document.getElementById('waiting-code').parentElement;
          waitingCode.parentElement.insertBefore(teamDisplay, waitingCode.nextSibling);
        }
      });
    }
  });
  
  gameRef.child('started').on('value', (snapshot) => {
    if (snapshot.val() === true) {
      startPlaying();
    }
  });
  
  // Listen for score updates
  gameRef.child('players/' + playerId + '/score').on('value', (snapshot) => {
    currentScore = snapshot.val() || 0;
    document.getElementById('player-score').textContent = currentScore;
  });
  
  // Store players reference for voting in Round 3
  gameRef.child('players').on('value', (snapshot) => {
    players = snapshot.val() || {};
  });
}

function startGameAsLead() {
  console.log('Start Game button clicked!');
  console.log('Game ref:', gameRef);
  
  // Trigger host to show team selection
  gameRef.update({
    readyToSelectTeams: true
  }).then(() => {
    console.log('Updated readyToSelectTeams to true');
  }).catch((error) => {
    console.error('Error updating Firebase:', error);
  });
  
  document.getElementById('waiting-message').textContent = 'Waiting for host to select teams...';
  document.getElementById('waiting-lead-controls').style.display = 'none';
  document.getElementById('waiting-spinner').style.display = 'block';
}

function startPlaying() {
  document.getElementById('waiting-screen').classList.remove('active');
  document.getElementById('game-screen').classList.add('active');
  document.getElementById('player-name-header').textContent = playerName;
  
  // Show team badge if assigned
  gameRef.child('players/' + playerId + '/team').once('value', (snapshot) => {
    const teamNumber = snapshot.val();
    if (teamNumber) {
      gameRef.child('team' + teamNumber).once('value', (teamSnapshot) => {
        const teamInfo = teamSnapshot.val();
        if (teamInfo) {
          const badge = document.getElementById('player-team-badge');
          badge.textContent = teamInfo.flag + ' ' + teamInfo.name;
          badge.style.display = 'block';
        }
      });
    }
  });
  
  // Listen for sabotage button activation
  gameRef.child('sabotage/' + playerId).on('value', (snapshot) => {
    const sabotageData = snapshot.val();
    if (sabotageData && sabotageData.active) {
      showSabotageButton();
    }
  });
  
  // Listen for round changes
  gameRef.child('round').on('value', (snapshot) => {
    currentRound = snapshot.val() || 1;
    if (currentRound === 3) {
      startRound3();
    }
  });
  
  // Listen for current question (Round 1)
  gameRef.child('currentQuestion').on('value', (snapshot) => {
    if (currentRound === 1) {
      const questionIndex = snapshot.val();
      if (questionIndex !== null && questionIndex !== currentQuestionIndex) {
        loadQuestion(questionIndex);
      }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUESTION DISPLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadQuestion(index) {
  if (index >= ROUND_1_QUESTIONS.length) return;
  
  currentQuestionIndex = index;
  const q = ROUND_1_QUESTIONS[index];
  
  document.getElementById('question-text').textContent = q.question;
  document.getElementById('status-message').classList.add('hidden');
  
  const optionsContainer = document.getElementById('answer-options');
  const letters = ['A', 'B', 'C', 'D'];
  
  optionsContainer.innerHTML = q.answers.map((answer, i) => `
    <button class="answer-btn" id="answer-${i}" onclick="selectAnswer(${i})">
      <div class="answer-btn-letter">${letters[i]}</div>
      <div class="answer-btn-text">${answer}</div>
    </button>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANSWER SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function selectAnswer(answerIndex) {
  // Check if already answered
  gameRef.child('answers/' + currentQuestionIndex + '/' + playerId).once('value', (snapshot) => {
    if (snapshot.exists()) {
      return; // Already answered
    }
    
    // Record answer
    gameRef.child('answers/' + currentQuestionIndex + '/' + playerId).set({
      answerIndex: answerIndex,
      timestamp: Date.now()
    });
    
    // Disable all buttons and highlight selection
    document.querySelectorAll('.answer-btn').forEach(btn => {
      btn.classList.add('disabled');
      btn.onclick = null;
    });
    document.getElementById('answer-' + answerIndex).classList.add('selected');
    
    // Show status with icon
    document.getElementById('status-icon').textContent = '‚úì';
    document.getElementById('status-text').textContent = 'Answer submitted!';
    document.getElementById('status-message').classList.remove('hidden');
    
    // Add haptic feedback if available
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLEANUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Handle disconnect
window.addEventListener('beforeunload', () => {
  if (gameRef && playerId) {
    gameRef.child('players/' + playerId).remove();
  }
});

// Prevent accidental refresh during game
window.addEventListener('beforeunload', (e) => {
  if (document.getElementById('game-screen').classList.contains('active')) {
    e.preventDefault();
    e.returnValue = 'Game in progress. Are you sure you want to leave?';
    return e.returnValue;
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROUND 3 - INTERVIEW & VOTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function startRound3() {
  document.getElementById('game-screen').classList.remove('active');
  document.getElementById('voting-screen').classList.add('active');
  document.getElementById('voting-player-name').textContent = playerName;
  document.getElementById('voting-score').textContent = currentScore;
  
  // Show team badge
  gameRef.child('players/' + playerId + '/team').once('value', (snapshot) => {
    const teamNumber = snapshot.val();
    if (teamNumber) {
      gameRef.child('team' + teamNumber).once('value', (teamSnapshot) => {
        const teamInfo = teamSnapshot.val();
        if (teamInfo) {
          const badge = document.getElementById('voting-team-badge');
          badge.textContent = teamInfo.flag + ' ' + teamInfo.name;
          badge.style.display = 'block';
        }
      });
    }
  });
  
  // Listen for Round 3 questions
  gameRef.child('currentRound3Question').on('value', (snapshot) => {
    const questionIndex = snapshot.val();
    if (questionIndex !== null && questionIndex !== round3CurrentQ) {
      round3CurrentQ = questionIndex;
      loadRound3Question(questionIndex);
    }
  });
}

function loadRound3Question(index) {
  if (index >= ROUND_3_QUESTIONS.length) return;
  
  const q = ROUND_3_QUESTIONS[index];
  document.getElementById('voting-header-text').textContent = q.question;
  document.getElementById('voting-status').classList.add('hidden');
  
  // Get this player's answer options from Firebase
  gameRef.child('round3/' + index + '/playerOptions/' + playerId).once('value', (snapshot) => {
    const options = snapshot.val();
    if (options && options.length > 0) {
      showRound3AnswerOptions(options, index);
    } else {
      // Host hasn't set options yet, wait
      document.getElementById('vote-options').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Waiting for question...</div>';
      
      // Listen for when options are set
      gameRef.child('round3/' + index + '/playerOptions/' + playerId).on('value', (snap) => {
        const opts = snap.val();
        if (opts && opts.length > 0) {
          showRound3AnswerOptions(opts, index);
        }
      });
    }
  });
}

function showRound3AnswerOptions(options, questionIndex) {
  const optionsContainer = document.getElementById('vote-options');
  const letters = ['A', 'B', 'C', 'D'];
  
  optionsContainer.innerHTML = options.map((answer, i) => `
    <button class="vote-btn" id="round3-answer-${i}" onclick="submitRound3Answer('${answer.replace(/'/g, "\\'")}', ${questionIndex})">
      <div class="vote-player-name">Option ${letters[i]}</div>
      <div class="vote-answer-text">${answer}</div>
    </button>
  `).join('');
}

function submitRound3Answer(answer, questionIndex) {
  // Check if already submitted
  if (myRound3Answers[questionIndex]) {
    return;
  }
  
  myRound3Answers[questionIndex] = answer;
  
  // Submit to Firebase
  gameRef.child('round3/' + questionIndex + '/submissions/' + playerId).set({
    answer: answer,
    votes: 0,
    timestamp: Date.now()
  });
  
  // Show status and switch to voting view
  document.getElementById('voting-status-icon').textContent = '‚úì';
  document.getElementById('voting-status-text').textContent = 'Answer submitted! Now vote for the best answer...';
  document.getElementById('voting-status').classList.remove('hidden');
  
  // Disable answer buttons
  document.querySelectorAll('.vote-btn').forEach(btn => {
    btn.classList.add('disabled');
    btn.onclick = null;
  });
  
  // Listen for all submissions to enable voting
  setTimeout(() => {
    listenForVoting(questionIndex);
  }, 2000);
}

function listenForVoting(questionIndex) {
  gameRef.child('round3/' + questionIndex + '/submissions').on('value', (snapshot) => {
    const submissions = snapshot.val() || {};
    const submissionArray = Object.entries(submissions).map(([pid, data]) => ({
      playerId: pid,
      playerName: players[pid]?.name || 'Unknown',
      answer: data.answer,
      votes: data.votes || 0
    }));
    
    // Check if all players submitted
    const totalPlayers = Object.keys(players).length;
    if (submissionArray.length >= totalPlayers) {
      showVotingOptions(submissionArray, questionIndex);
    }
  });
}

function showVotingOptions(submissions, questionIndex) {
  document.getElementById('voting-header-text').textContent = 'Vote for the best answer!';
  const optionsContainer = document.getElementById('vote-options');
  
  optionsContainer.innerHTML = submissions.map((sub, i) => {
    const isOwn = sub.playerId === playerId;
    return `
      <button class="vote-btn ${isOwn ? 'own-answer' : ''}" id="vote-option-${i}" 
              onclick="${isOwn ? '' : `voteForAnswer('${sub.playerId}', ${questionIndex})`}" 
              ${isOwn ? 'disabled' : ''}>
        <div class="vote-player-name">${sub.playerName}${isOwn ? ' (You)' : ''}</div>
        <div class="vote-answer-text">${sub.answer}</div>
      </button>
    `;
  }).join('');
}

function voteForAnswer(targetPlayerId, questionIndex) {
  // Check if already voted
  gameRef.child('round3/' + questionIndex + '/votes/' + playerId).once('value', (snapshot) => {
    if (snapshot.exists()) {
      return; // Already voted
    }
    
    // Record vote
    gameRef.child('round3/' + questionIndex + '/votes/' + playerId).set(targetPlayerId);
    
    // Increment vote count for target player
    gameRef.child('round3/' + questionIndex + '/submissions/' + targetPlayerId).once('value', (snap) => {
      const currentVotes = snap.val()?.votes || 0;
      gameRef.child('round3/' + questionIndex + '/submissions/' + targetPlayerId + '/votes').set(currentVotes + 1);
    });
    
    // Give voter a point for participating
    gameRef.child('players/' + playerId + '/score').once('value', (snap) => {
      const newScore = (snap.val() || 0) + 1;
      gameRef.child('players/' + playerId + '/score').set(newScore);
    });
    
    // Show voted status
    document.querySelectorAll('.vote-btn').forEach((btn, i) => {
      if (btn.id === 'vote-option-' + Array.from(document.querySelectorAll('.vote-btn')).findIndex(b => b.onclick && b.onclick.toString().includes(targetPlayerId))) {
        btn.classList.add('voted');
      }
      btn.classList.add('disabled');
      btn.onclick = null;
    });
    
    document.getElementById('voting-status-icon').textContent = 'üéâ';
    document.getElementById('voting-status-text').textContent = 'Vote recorded!';
    document.getElementById('voting-status').classList.remove('hidden');
    
    // Add haptic feedback
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLEANUP & UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SABOTAGE BUTTON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showSabotageButton() {
  const overlay = document.getElementById('sabotage-overlay');
  overlay.classList.add('active');
  
  sabotageTimeLeft = 10;
  document.getElementById('sabotage-timer').textContent = sabotageTimeLeft;
  
  // Countdown timer
  sabotageTimer = setInterval(() => {
    sabotageTimeLeft--;
    document.getElementById('sabotage-timer').textContent = sabotageTimeLeft;
    
    if (sabotageTimeLeft <= 0) {
      hideSabotageButton();
    }
  }, 1000);
  
  // Vibrate if available
  if (navigator.vibrate) {
    navigator.vibrate([200, 100, 200]);
  }
}

function hideSabotageButton() {
  clearInterval(sabotageTimer);
  document.getElementById('sabotage-overlay').classList.remove('active');
}

function useSabotage() {
  // Get player's team and target the other team
  gameRef.child('players/' + playerId + '/team').once('value', (snapshot) => {
    const myTeam = snapshot.val();
    const targetTeam = myTeam === 1 ? 2 : 1;
    
    // Trigger sabotage
    gameRef.child('sabotageUsed').set({
      userId: playerId,
      targetTeam: targetTeam,
      timestamp: Date.now()
    });
    
    // Hide button
    hideSabotageButton();
    
    // Show success message
    alert('üí£ SABOTAGE ACTIVATED! -5 points from the other team!');
    
    // Vibrate success
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 100, 50, 100]);
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLEANUP & UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Auto-uppercase game code as user types
document.getElementById('code-input').addEventListener('input', (e) => {
  e.target.value = e.target.value.toUpperCase();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEAD PLAYER CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function startGameAsLead() {
  if (!isLeadPlayer) return;
  gameRef.update({ started: true, currentQuestion: 0 });
}

function revealAnswerAsLead() {
  if (!isLeadPlayer) return;
  gameRef.update({ revealAnswer: true });
}

function nextQuestionAsLead() {
  if (!isLeadPlayer) return;
  gameRef.child('currentQuestion').once('value', (snapshot) => {
    const current = snapshot.val() || 0;
    gameRef.update({ nextQuestion: current + 1 });
  });
}
</script>

</body>
</html>

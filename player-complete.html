
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Quiz Player - Mobile</title>
<!-- VERSION: 6.0 - Home/Away text + simultaneous selection -->
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Barlow+Condensed:ital,wght@0,400;0,600;0,700;1,400&family=Barlow:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">

<!-- 
  FIREBASE SETUP REQUIRED
  Replace the firebaseConfig below with YOUR EXACT SAME CONFIG from host-complete.html
-->

<style>
  :root {
    --motd-magenta: #d4145a;
    --motd-red: #c81e5b;
    --motd-navy: #2c3e69;
    --motd-dark-navy: #1a2540;
    --motd-cyan: #4dd4e8;
    --motd-gold: #ffc629;
    --text: #ffffff;
    --text-muted: #a8b4d0;
    --border: #3e5c8f;
  }
  
  * { margin: 0; padding: 0; box-sizing: border-box; }
  
  body {
    font-family: 'Barlow', sans-serif;
    background: linear-gradient(135deg, var(--motd-dark-navy) 0%, var(--motd-navy) 100%);
    color: var(--text);
    min-height: 100vh;
    touch-action: manipulation;
    -webkit-user-select: none;
    user-select: none;
  }
  
  .container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }
  
  /* JOIN SCREEN */
  .join-screen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
  }
  
  .join-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    letter-spacing: 3px;
    color: var(--text);
    text-shadow: 0 0 30px rgba(212,20,90,0.8);
    margin-bottom: 10px;
    text-align: center;
  }
  
  .join-subtitle {
    font-family: 'Barlow', sans-serif;
    font-size: 16px;
    color: var(--text-muted);
    margin-bottom: 40px;
    text-align: center;
  }
  
  .join-form {
    width: 100%;
    max-width: 400px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .input-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  
  .input-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
  }
  
  .input-field {
    background: var(--motd-navy);
    border: 2px solid var(--border);
    color: var(--text);
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 20px;
    font-weight: 600;
    padding: 16px;
    border-radius: 8px;
    text-transform: uppercase;
    letter-spacing: 4px;
    text-align: center;
  }
  
  .input-field:focus {
    outline: none;
    border-color: var(--motd-cyan);
  }
  
  .input-field.name-input {
    text-transform: none;
    letter-spacing: 1px;
  }
  
  .join-btn {
    background: linear-gradient(135deg, var(--motd-magenta) 0%, var(--motd-red) 100%);
    color: white;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    letter-spacing: 4px;
    padding: 18px;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 4px 20px rgba(212,20,90,0.5);
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  
  .join-btn:active {
    transform: translateY(2px);
  }
  
  .error-message {
    background: var(--motd-magenta);
    color: white;
    padding: 12px;
    border-radius: 6px;
    font-size: 14px;
    text-align: center;
    display: none;
  }
  
  .error-message.show {
    display: block;
    animation: shake 0.3s ease;
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-10px); }
    75% { transform: translateX(10px); }
  }
  
  /* WAITING SCREEN */
  .waiting-screen {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    text-align: center;
  }
  
  .waiting-screen.active {
    display: flex;
  }
  
  .waiting-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 36px;
    letter-spacing: 3px;
    color: var(--motd-cyan);
    margin-bottom: 20px;
  }
  
  .waiting-message {
    font-family: 'Barlow', sans-serif;
    font-size: 18px;
    color: var(--text-muted);
    margin-bottom: 40px;
  }
  
  .player-info {
    background: var(--motd-navy);
    border: 2px solid var(--motd-cyan);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  
  .player-info-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 12px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 8px;
  }
  
  .player-info-value {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    letter-spacing: 3px;
    color: var(--motd-cyan);
  }
  
  .spinner {
    width: 50px;
    height: 50px;
    border: 4px solid var(--border);
    border-top-color: var(--motd-cyan);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  
  /* GAME SCREEN */
  .game-screen {
    display: none;
    flex-direction: column;
    flex: 1;
  }
  
  .game-screen.active {
    display: flex;
  }
  
  .player-header {
    background: var(--motd-navy);
    border: 2px solid var(--border);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
  }
  
  .player-team-badge {
    position: absolute;
    top: -10px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--motd-gold);
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.3);
  }
  
  .player-name-display {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    font-weight: 600;
  }
  
  .player-score-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: var(--motd-cyan);
  }
  
  .question-prompt {
    background: var(--motd-navy);
    border: 3px solid var(--motd-gold);
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .question-prompt-text {
    font-family: 'Barlow', sans-serif;
    font-size: 18px;
    line-height: 1.5;
    color: var(--text);
  }
  
  .answer-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
  }
  
  .answer-btn {
    background: var(--motd-dark-navy);
    border: 3px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  
  .answer-btn:active:not(.disabled) {
    transform: scale(0.98);
  }
  
  .answer-btn-letter {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 32px;
    color: var(--motd-cyan);
    min-width: 40px;
  }
  
  .answer-btn-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    font-weight: 600;
    flex: 1;
    color: var(--text);
  }
  
  .answer-btn.selected {
    border-color: var(--motd-cyan);
    background: rgba(77,212,232,0.2);
    animation: pulse 0.3s ease;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }
  
  .answer-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .status-message {
    background: var(--motd-navy);
    border: 2px solid var(--motd-cyan);
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    margin-top: 20px;
  }
  
  .status-message-text {
    font-family: 'Barlow', sans-serif;
    font-size: 16px;
    color: var(--motd-cyan);
  }
  
  .status-icon {
    font-size: 32px;
    margin-bottom: 10px;
  }
  
  /* SABOTAGE BUTTON */
  .sabotage-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
  }
  
  .sabotage-overlay.active {
    display: flex;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }
  
  .sabotage-container {
    text-align: center;
    animation: zoomIn 0.3s ease;
  }
  
  @keyframes zoomIn {
    from { transform: scale(0.8); opacity: 0; }
    to { transform: scale(1); opacity: 1; }
  }
  
  .sabotage-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 48px;
    color: var(--motd-magenta);
    text-shadow: 0 0 30px rgba(212,20,90,0.8);
    margin-bottom: 20px;
    letter-spacing: 3px;
  }
  
  .sabotage-subtitle {
    font-family: 'Barlow', sans-serif;
    font-size: 20px;
    color: var(--text-muted);
    margin-bottom: 30px;
  }
  
  .sabotage-timer {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 64px;
    color: var(--motd-gold);
    margin-bottom: 30px;
    text-shadow: 0 0 20px rgba(255,198,41,0.6);
  }
  
  .sabotage-btn {
    background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
    color: white;
    border: 3px solid var(--motd-gold);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 42px;
    letter-spacing: 5px;
    padding: 30px 60px;
    border-radius: 12px;
    cursor: pointer;
    box-shadow: 0 8px 40px rgba(255,0,0,0.6);
    transition: all 0.2s;
    animation: pulse 1s ease-in-out infinite;
    -webkit-tap-highlight-color: transparent;
  }
  
  .sabotage-btn:active {
    transform: scale(0.95);
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); box-shadow: 0 8px 40px rgba(255,0,0,0.6); }
    50% { transform: scale(1.05); box-shadow: 0 12px 60px rgba(255,0,0,0.9); }
  }
  
  .sabotage-warning {
    font-family: 'Barlow', sans-serif;
    font-size: 14px;
    color: var(--motd-magenta);
    margin-top: 20px;
    font-style: italic;
  }
  
  /* LEAD PLAYER CONTROLS */
  .lead-controls {
    display: none;
    flex-direction: column;
    gap: 10px;
    margin-top: 20px;
    align-items: center;
  }
  
  .lead-controls.visible {
    display: flex;
  }
  
  .lead-btn {
    flex: 1;
    background: var(--motd-gold);
    color: #000;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px;
    letter-spacing: 3px;
    padding: 16px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.2s;
  }
  
  .lead-btn:active {
    transform: scale(0.98);
  }
  
  .lead-btn.primary {
    background: linear-gradient(135deg, var(--motd-magenta) 0%, var(--motd-red) 100%);
    color: white;
  }
  
  .lead-badge {
    background: var(--motd-gold);
    color: #000;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 14px;
    letter-spacing: 2px;
    padding: 6px 12px;
    border-radius: 6px;
    display: inline-block;
    margin-left: 8px;
  }
  
  /* TEAM SELECTION MOBILE */
  .team-selection-mobile {
    display: none;
    flex-direction: column;
    padding: 20px;
    flex: 1;
    overflow-y: auto;
  }
  
  .team-selection-mobile.active {
    display: flex;
  }
  
  .team-selection-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 42px;
    letter-spacing: 3px;
    color: var(--text);
    text-align: center;
    margin-bottom: 10px;
  }
  
  .team-selection-subtitle {
    font-family: 'Barlow', sans-serif;
    font-size: 18px;
    color: var(--motd-gold);
    text-align: center;
    margin-bottom: 30px;
  }
  
  .teams-grid-mobile {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-bottom: 20px;
  }
  
  .team-option-mobile {
    background: var(--motd-navy);
    border: 3px solid var(--border);
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  
  .team-option-mobile:active {
    transform: scale(0.95);
  }
  
  .team-option-mobile.selected {
    border-color: var(--motd-gold);
    background: rgba(255,198,41,0.2);
  }
  
  .team-option-mobile.disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }
  
  .team-flag-mobile {
    font-size: 48px;
    margin-bottom: 8px;
  }
  
  .team-name-mobile {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }

  /* ROUND 2 - PUNNED IT */
  .pun-input-screen {
    display: none;
  }
  
  .pun-input-screen.active {
    display: flex;
  }
  
  .pun-category-banner {
    background: var(--motd-navy);
    border: 3px solid var(--motd-gold);
    border-radius: 12px;
    padding: 30px;
    margin-bottom: 30px;
    text-align: center;
  }
  
  .pun-category-label {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    color: var(--text-muted);
    margin-bottom: 10px;
    letter-spacing: 2px;
  }
  
  .pun-category-name {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 42px;
    color: var(--motd-gold);
    letter-spacing: 3px;
  }
  
  .pun-input-area {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  
  .pun-input-field {
    width: 100%;
    padding: 20px;
    font-family: 'Barlow', sans-serif;
    font-size: 20px;
    background: rgba(255,255,255,0.1);
    border: 3px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    resize: vertical;
    min-height: 120px;
  }
  
  .pun-submit-btn {
    width: 100%;
    padding: 20px;
    font-family: 'Oswald', sans-serif;
    font-size: 24px;
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
    background: var(--motd-gold);
    color: #000;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 6px 0 #d4a317, 0 10px 20px rgba(0,0,0,0.4);
    transition: transform 0.1s;
  }
  
  .pun-submit-btn:active {
    transform: translateY(4px);
    box-shadow: 0 2px 0 #d4a317, 0 4px 10px rgba(0,0,0,0.4);
  }
  
  .pun-submit-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* ROUND 3 - VOTING */
  .voting-screen {
    display: none;
    flex-direction: column;
    flex: 1;
  }
  
  .voting-screen.active {
    display: flex;
  }
  
  .voting-header {
    background: var(--motd-navy);
    border: 2px solid var(--motd-gold);
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    text-align: center;
  }
  
  .voting-header-text {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 18px;
    font-weight: 600;
    color: var(--motd-gold);
    text-transform: uppercase;
    letter-spacing: 2px;
  }
  
  .vote-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
    flex: 1;
    overflow-y: auto;
  }
  
  .vote-btn {
    background: var(--motd-dark-navy);
    border: 3px solid var(--border);
    border-radius: 8px;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    cursor: pointer;
    transition: all 0.2s;
    -webkit-tap-highlight-color: transparent;
  }
  
  .vote-btn:active:not(.disabled):not(.voted):not(.own-answer) {
    transform: scale(0.98);
  }
  
  .vote-player-name {
    font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--motd-cyan);
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  
  .vote-answer-text {
    font-family: 'Barlow', sans-serif;
    font-size: 18px;
    line-height: 1.4;
    color: var(--text);
  }
  
  .vote-btn.voted {
    border-color: var(--motd-gold);
    background: rgba(255,198,41,0.15);
  }
  
  .vote-btn.own-answer {
    opacity: 0.5;
    cursor: not-allowed;
    border-style: dashed;
  }
  
  .vote-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .hidden {
    display: none !important;
  }
</style>
</head>
<body>

<div class="container">
  
  <!-- JOIN SCREEN -->
  <div class="join-screen" id="join-screen">
    <div class="join-title">Join Game</div>
    <div class="join-subtitle">Enter your details to play</div>
    
    <form class="join-form" onsubmit="joinGame(event)">
      <div class="input-group">
        <label class="input-label">Game Code</label>
        <input type="text" class="input-field" id="code-input" maxlength="4" placeholder="XXXX" required autocomplete="off">
      </div>
      
      <div class="input-group">
        <label class="input-label">Your Name</label>
        <input type="text" class="input-field name-input" id="name-input" maxlength="20" placeholder="Enter name" required autocomplete="off">
      </div>
      
      <div class="error-message" id="error-message"></div>
      
      <button type="submit" class="join-btn">Join Game</button>
    </form>
  </div>

  <!-- WAITING SCREEN -->
  <div class="waiting-screen" id="waiting-screen">
    <div class="waiting-title">You're In!</div>
    <div class="waiting-message" id="waiting-message">Waiting for host to start the game...</div>
    
    <div class="player-info">
      <div class="player-info-label">Your Name</div>
      <div class="player-info-value" id="waiting-name"></div>
    </div>
    
    <div class="player-info">
      <div class="player-info-label">Game Code</div>
      <div class="player-info-value" id="waiting-code"></div>
    </div>
    
    <div class="lead-controls" id="waiting-lead-controls">
      <button class="lead-btn primary" onclick="startGameAsLead()">üéÆ Start Game</button>
    </div>
    
    <div style="display: none; text-align: center; font-family: 'Barlow', sans-serif; font-size: 14px; color: var(--text-muted); margin-top: 10px; font-style: italic;" id="start-game-note">
      Only click when all players are ready
    </div>
    
    <div class="spinner" id="waiting-spinner"></div>
  </div>

  <!-- GAME SCREEN -->
  <div class="game-screen" id="game-screen">
    <div class="player-header">
      <div class="player-team-badge" id="player-team-badge" style="display: none;"></div>
      <div>
        <span class="player-name-display" id="player-name-header"></span>
      </div>
      <div class="player-score-display"><span id="player-score">0</span> pts</div>
    </div>
    
    <div class="question-prompt">
      <div class="question-prompt-text" id="question-text">Loading...</div>
    </div>
    
    <div class="answer-options" id="answer-options"></div>
    
    <div class="status-message hidden" id="status-message">
      <div class="status-icon" id="status-icon">‚úì</div>
      <div class="status-message-text" id="status-text"></div>
    </div>
    
    <div class="lead-controls" id="game-lead-controls">
      <button class="lead-btn" id="reveal-lead-btn" onclick="revealAnswerAsLead()">Reveal Answer</button>
      <button class="lead-btn primary" id="next-lead-btn" onclick="nextQuestionAsLead()">Next ‚Üí</button>
    </div>
  </div>

  <!-- TEAM SELECTION SCREEN -->
  <div class="team-selection-mobile" id="team-selection-mobile">
    <div class="team-selection-title">Choose Your Team</div>
    <div class="team-selection-subtitle" id="team-selection-subtitle">You're picking first!</div>
    
    <div class="teams-grid-mobile" id="teams-grid-mobile"></div>
    
    <div class="spinner" id="team-selection-spinner" style="display: none;"></div>
    <div class="waiting-message" id="team-selection-waiting" style="display: none;">Waiting for other player to choose...</div>
  </div>

  <!-- ROUND 2 - PUN INPUT SCREEN -->
  <div class="pun-input-screen" id="pun-input-screen">
    <div class="player-header">
      <div class="player-team-badge" id="pun-team-badge" style="display: none;"></div>
      <div class="player-name-display" id="pun-player-name"></div>
      <div class="player-score-display"><span id="pun-score">0</span> pts</div>
    </div>
    
    <div class="pun-category-banner">
      <div class="pun-category-label">Make a pun about:</div>
      <div class="pun-category-name" id="player-pun-category">Loading...</div>
    </div>
    
    <div class="pun-input-area">
      <textarea 
        id="pun-input" 
        class="pun-input-field" 
        placeholder="Turn a footballer's name into a pun... e.g. 'Pelican' (Pele + Bird)"
        maxlength="100"
      ></textarea>
      
      <button class="pun-submit-btn" id="pun-submit-btn" onclick="submitPun()">
        ‚úçÔ∏è SUBMIT PUN
      </button>
    </div>
    
    <div class="status-message hidden" id="pun-status">
      <div class="status-icon" id="pun-status-icon">‚úì</div>
      <div class="status-message-text" id="pun-status-text"></div>
    </div>
  </div>

  <!-- ROUND 3 - VOTING SCREEN -->
  <div class="voting-screen" id="voting-screen">
    <div class="player-header">
      <div class="player-team-badge" id="voting-team-badge" style="display: none;"></div>
      <div class="player-name-display" id="voting-player-name"></div>
      <div class="player-score-display"><span id="voting-score">0</span> pts</div>
    </div>
    
    <div class="voting-header">
      <div class="voting-header-text" id="voting-header-text">Vote for the best answer!</div>
    </div>
    
    <div class="vote-options" id="vote-options"></div>
    
    <div class="status-message hidden" id="voting-status">
      <div class="status-icon" id="voting-status-icon">‚úì</div>
      <div class="status-message-text" id="voting-status-text"></div>
    </div>
  </div>

  <!-- OFFSIDE TRAP OVERLAY -->
  <div class="sabotage-overlay" id="offside-overlay">
    <div class="sabotage-container">
      <div class="sabotage-title">‚ö†Ô∏è OFFSIDE TRAP ‚ö†Ô∏è</div>
      <div class="sabotage-subtitle">Steal 2 points from each opponent!</div>
      <div class="sabotage-timer" id="offside-timer">15</div>
      <button class="sabotage-btn" onclick="useOffsideTrap()">
        üö© SPRING THE TRAP üö©
      </button>
      <div class="sabotage-warning">Only you can see this! Act fast...</div>
    </div>
  </div>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIGURATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyAHgjTr_l8_dbNeSAmWkTh5NXg94fAh0QQ",
  authDomain: "soccer-quiz-game-cf039.firebaseapp.com",
  databaseURL: "https://soccer-quiz-game-cf039-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "soccer-quiz-game-cf039",
  storageBucket: "soccer-quiz-game-cf039.firebasestorage.app",
  messagingSenderId: "561666470759",
  appId: "1:561666470759:web:036f2dd3ad884a12cef5c2"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME DATA - MUST MATCH HOST EXACTLY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// World Cup Finalists
const WORLD_CUP_FINALISTS = [
  { name: "Argentina", flag: "üá¶üá∑", color: "#75AADB" },
  { name: "Brazil", flag: "üáßüá∑", color: "#009B3A" },
  { name: "Germany", flag: "üá©üá™", color: "#000000" },
  { name: "Italy", flag: "üáÆüáπ", color: "#0066CC" },
  { name: "France", flag: "üá´üá∑", color: "#0055A4" },
  { name: "Vatican City", flag: "üáªüá¶", color: "#FFE000" },
  { name: "England", flag: "üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø", color: "#C8102E" },
  { name: "Spain", flag: "üá™üá∏", color: "#C60B1E" },
  { name: "Netherlands", flag: "üá≥üá±", color: "#FF4F00" },
  { name: "Uruguay", flag: "üá∫üáæ", color: "#0038A8" },
  { name: "Croatia", flag: "üá≠üá∑", color: "#FF0000" },
  { name: "Czechia", flag: "üá®üáø", color: "#D7141A" },
  { name: "Hungary", flag: "üá≠üá∫", color: "#436F4D" },
  { name: "Sweden", flag: "üá∏üá™", color: "#006AA7" }
];

const ROUND_1_QUESTIONS = [
  {
    question: "Mercenary swords, they are feeble reeds... already the Eagle of Austria has lost its feathers.",
    answers: ["Italy", "Austria", "Germany", "Hong Kong"]
  },
  {
    question: "To the King of Spain I have always given honour.",
    answers: ["Netherlands", "Spain", "Ireland", "Argentina"]
  },
  {
    question: "This country's national anthem is famous for having no official lyrics at all. Which nation?",
    answers: ["Spain", "DR Congo", "Bhutan", "Austria"]
  },
  {
    question: "Which one of these was NOT an official World Cup song?",
    answers: ["Balls Balls Balls", "World Cup Willie", "Far Away In America", "Meat Pie, Sausage Roll"]
  }
];

// Round 3 - Interview Questions
const ROUND_3_QUESTIONS = [
  {
    question: "The team looked tired. What did you give them at half time?"
  },
  {
    question: "What are you most concerned about in the next round?"
  },
  {
    question: "Is there anything keeping you up at night?"
  }
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let gameCode = '';
let playerName = '';
let playerId = '';
let gameRef = null;
let currentScore = 0;
let currentQuestionIndex = -1;
let currentRound = 1;
let round3CurrentQ = -1;
let myRound3Answers = {};
let sabotageTimer = null;
let sabotageTimeLeft = 10;
let players = {}; // For Round 3 voting
let isLeadPlayer = false;

// Check if code is in URL
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.has('code')) {
  document.getElementById('code-input').value = urlParams.get('code');
}

// Check if this is spectator mode
const isSpectator = urlParams.has('spectator') || urlParams.has('audience');
let spectatorId = null;

if (isSpectator && urlParams.has('code')) {
  // Auto-join as spectator
  gameCode = urlParams.get('code').toUpperCase();
  spectatorId = 'spectator_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  // Hide join screen, show spectator waiting
  document.getElementById('join-screen').classList.add('hidden');
  document.getElementById('waiting-screen').classList.add('active');
  document.getElementById('waiting-name').textContent = 'Spectator';
  document.getElementById('waiting-code').textContent = gameCode;
  document.getElementById('waiting-message').textContent = 'Watching as audience member...';
  
  gameRef = database.ref('games/' + gameCode);
  joinAsSpectator();
}

// Auto-focus code input
document.getElementById('code-input').focus();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SPECTATOR MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function joinAsSpectator() {
  // Track spectator in Firebase (separate from players)
  gameRef.child('spectators/' + spectatorId).set({
    joinedAt: Date.now()
  });
  
  // Listen for game start
  gameRef.child('started').on('value', (snapshot) => {
    if (snapshot.val() === true) {
      startSpectating();
    }
  });
}

function startSpectating() {
  document.getElementById('waiting-screen').classList.remove('active');
  document.getElementById('game-screen').classList.add('active');
  document.getElementById('player-name-header').textContent = 'Audience';
  
  // Show spectator badge
  const badge = document.getElementById('player-team-badge');
  badge.textContent = 'üëÅÔ∏è Spectator';
  badge.style.display = 'block';
  badge.style.background = 'rgba(77,212,232,0.2)';
  badge.style.borderColor = 'var(--motd-cyan)';
  
  // Listen for questions
  gameRef.child('currentQuestion').on('value', (snapshot) => {
    if (currentRound === 1) {
      const questionIndex = snapshot.val();
      if (questionIndex !== null && questionIndex !== currentQuestionIndex) {
        loadQuestionForSpectator(questionIndex);
      }
    }
  });
  
  // Listen for answer reveals
  gameRef.child('answers').on('value', () => {
    // Spectators don't see reveal, they just vote
  });
  
  // Track spectator votes separately
  currentScore = 0;
  document.getElementById('player-score').textContent = currentScore;
}

function loadQuestionForSpectator(index) {
  currentQuestionIndex = index;
  const q = ROUND_1_QUESTIONS[index];
  
  document.getElementById('question-text').textContent = q.question;
  document.getElementById('status-message').classList.add('hidden');
  
  const optionsContainer = document.getElementById('answer-options');
  const letters = ['A', 'B', 'C', 'D'];
  
  optionsContainer.innerHTML = q.answers.map((answer, i) => `
    <button class="answer-btn" id="answer-${i}" onclick="spectatorVote(${i})">
      <div class="answer-btn-letter">${letters[i]}</div>
      <div class="answer-btn-text">${answer}</div>
    </button>
  `).join('');
}

function spectatorVote(answerIndex) {
  // Check if already voted
  gameRef.child('spectatorVotes/' + currentQuestionIndex + '/' + spectatorId).once('value', (snapshot) => {
    if (snapshot.exists()) {
      return; // Already voted
    }
    
    const q = ROUND_1_QUESTIONS[currentQuestionIndex];
    
    // Record vote
    gameRef.child('spectatorVotes/' + currentQuestionIndex + '/' + spectatorId).set({
      answerIndex: answerIndex,
      timestamp: Date.now(),
      correct: answerIndex === q.correct
    });
    
    // Award point if correct
    if (answerIndex === q.correct) {
      currentScore++;
      document.getElementById('player-score').textContent = currentScore;
    }
    
    // Disable all buttons and highlight selection
    document.querySelectorAll('.answer-btn').forEach(btn => {
      btn.classList.add('disabled');
      btn.onclick = null;
    });
    document.getElementById('answer-' + answerIndex).classList.add('selected');
    
    // Show status
    document.getElementById('status-icon').textContent = '‚úì';
    document.getElementById('status-text').textContent = 'Vote recorded!';
    document.getElementById('status-message').classList.remove('hidden');
    
    // Vibrate
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JOIN GAME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function joinGame(event) {
  event.preventDefault();
  console.log('Join clicked');
  
  gameCode = document.getElementById('code-input').value.toUpperCase().trim();
  playerName = document.getElementById('name-input').value.trim();
  
  if (!gameCode || !playerName) {
    alert('Please enter code and name');
    return;
  }
  
  gameRef = database.ref('games/' + gameCode);
  gameRef.once('value').then((snapshot) => {
    if (!snapshot.exists()) {
      alert('Game not found');
      throw new Error('Game not found');
    }
    
    playerId = 'player_' + Date.now();
    return gameRef.child('players/' + playerId).set({
      name: playerName,
      score: 0,
      joinedAt: Date.now()
    });
  }).then(() => {
    document.getElementById('join-screen').classList.add('hidden');
    document.getElementById('waiting-screen').classList.add('active');
    document.getElementById('waiting-name').textContent = playerName;
    document.getElementById('waiting-code').textContent = gameCode;
    listenForGameStart();
  }).catch((error) => {
    console.error('Join error:', error);
    if (error.message !== 'Game not found') {
      alert('Error: ' + error.message);
    }
  });
}

function showError(message) {
  const errorEl = document.getElementById('error-message');
  errorEl.textContent = message;
  errorEl.classList.add('show');
  setTimeout(() => errorEl.classList.remove('show'), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME LISTENERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function listenForGameStart() {
  console.log('listenForGameStart called');
  console.log('gameRef:', gameRef);
  console.log('playerId:', playerId);
  
  if (!gameRef) {
    console.error('ERROR: gameRef is null!');
    alert('Internal error: Game reference not set');
    return;
  }
  
  // Check if this is the first player
  gameRef.child('players').once('value', (snapshot) => {
    const players = snapshot.val() || {};
    const playerIds = Object.keys(players);
    const isFirstPlayer = playerIds.length > 0 && playerIds[0] === playerId;
    
    console.log('Player IDs:', playerIds);
    console.log('My player ID:', playerId);
    console.log('Is first player:', isFirstPlayer);
    
    if (isFirstPlayer) {
      // Show start button for first player
      document.getElementById('waiting-message').textContent = 'You joined first! Select teams and start when ready.';
      const leadControls = document.getElementById('waiting-lead-controls');
      leadControls.style.display = 'flex';
      leadControls.style.justifyContent = 'center';
      document.getElementById('start-game-note').style.display = 'block';
      document.getElementById('waiting-spinner').style.display = 'none';
      console.log('Start button shown for first player');
    }
  });
  
  // Listen for team assignment
  gameRef.child('players/' + playerId + '/team').on('value', (snapshot) => {
    const teamNumber = snapshot.val();
    if (teamNumber) {
      // Get team info
      gameRef.child('team' + teamNumber).once('value', (teamSnapshot) => {
        const teamInfo = teamSnapshot.val();
        if (teamInfo) {
          // Update waiting screen with team info
          const teamDisplay = document.createElement('div');
          teamDisplay.className = 'player-info';
          teamDisplay.style.cssText = 'border-color: ' + (teamNumber === 1 ? '#4dd4e8' : '#d4145a');
          teamDisplay.innerHTML = `
            <div class="player-info-label">Your Team</div>
            <div class="player-info-value">${teamInfo.flag} ${teamInfo.name}</div>
          `;
          
          const waitingCode = document.getElementById('waiting-code').parentElement;
          waitingCode.parentElement.insertBefore(teamDisplay, waitingCode.nextSibling);
        }
      });
    }
  });
  
  gameRef.child('started').on('value', (snapshot) => {
    if (snapshot.val() === true) {
      startPlaying();
    }
  });
  
  // Listen for score updates
  gameRef.child('players/' + playerId + '/score').on('value', (snapshot) => {
    currentScore = snapshot.val() || 0;
    document.getElementById('player-score').textContent = currentScore;
  });
  
  // Listen for team selection phase
  gameRef.child('teamSelectionStarted').on('value', (snapshot) => {
    if (snapshot.val() === true) {
      showTeamSelectionScreen();
    }
  });
  
  // Listen for Round 1 explainer
  gameRef.child('showRound1Explainer').on('value', (snapshot) => {
    if (snapshot.val() === true) {
      showPlayerRound1Explainer();
    }
  });
  
  // Store players reference for voting in Round 3
  gameRef.child('players').on('value', (snapshot) => {
    players = snapshot.val() || {};
  });
}

let gameStartTriggered = false; // Prevent multiple clicks

function startGameAsLead() {
  if (gameStartTriggered) {
    console.log('‚ö†Ô∏è Start already triggered, ignoring');
    return;
  }
  
  gameStartTriggered = true;
  console.log('Start Game button clicked!');
  console.log('Game ref:', gameRef);
  
  // Disable the button
  const startBtn = document.querySelector('[onclick="startGameAsLead()"]');
  if (startBtn) {
    startBtn.disabled = true;
    startBtn.style.opacity = '0.5';
    startBtn.textContent = 'Starting...';
  }
  
  // Signal all players to choose teams AND trigger host music screen
  gameRef.update({
    teamSelectionStarted: true,
    readyToSelectTeams: true
  }).then(() => {
    console.log('Team selection started');
    showTeamSelectionScreen();
  }).catch((error) => {
    console.error('Error updating Firebase:', error);
    gameStartTriggered = false; // Reset on error
  });
}

function startPlaying() {
  // Hide all other screens
  document.getElementById('waiting-screen').classList.remove('active');
  document.getElementById('team-selection-mobile').classList.remove('active');
  
  // Show game screen
  document.getElementById('game-screen').classList.add('active');
  document.getElementById('player-name-header').textContent = playerName;
  
  // Show team badge if assigned
  gameRef.child('players/' + playerId + '/team').once('value', (snapshot) => {
    const teamNumber = snapshot.val();
    if (teamNumber) {
      gameRef.child('team' + teamNumber).once('value', (teamSnapshot) => {
        const teamInfo = teamSnapshot.val();
        if (teamInfo) {
          const badge = document.getElementById('player-team-badge');
          badge.textContent = teamInfo.flag + ' ' + teamInfo.name;
          badge.style.display = 'block';
        }
      });
    }
  });
  
  // Listen for sabotage button activation
  gameRef.child('sabotage/' + playerId).on('value', (snapshot) => {
    const sabotageData = snapshot.val();
    if (sabotageData && sabotageData.active) {
      showOffsideTrapButton();
    }
  });
  
  // Listen for round changes
  gameRef.child('round').on('value', (snapshot) => {
    currentRound = snapshot.val() || 1;
    if (currentRound === 3) {
      startRound3();
    }
  });
  
  // Listen for current question (Round 1)
  gameRef.child('currentQuestion').on('value', (snapshot) => {
    if (currentRound === 1) {
      const questionIndex = snapshot.val();
      if (questionIndex !== null && questionIndex !== currentQuestionIndex) {
        loadQuestion(questionIndex);
      }
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUESTION DISPLAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadQuestion(index) {
  if (index >= ROUND_1_QUESTIONS.length) return;
  
  currentQuestionIndex = index;
  const q = ROUND_1_QUESTIONS[index];
  
  document.getElementById('question-text').textContent = q.question;
  document.getElementById('status-message').classList.add('hidden');
  
  const optionsContainer = document.getElementById('answer-options');
  const letters = ['A', 'B', 'C', 'D'];
  
  optionsContainer.innerHTML = q.answers.map((answer, i) => `
    <button class="answer-btn" id="answer-${i}" onclick="selectAnswer(${i})">
      <div class="answer-btn-letter">${letters[i]}</div>
      <div class="answer-btn-text">${answer}</div>
    </button>
  `).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANSWER SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function selectAnswer(answerIndex) {
  // Check if already answered
  gameRef.child('answers/' + currentQuestionIndex + '/' + playerId).once('value', (snapshot) => {
    if (snapshot.exists()) {
      return; // Already answered
    }
    
    // Record answer
    gameRef.child('answers/' + currentQuestionIndex + '/' + playerId).set({
      answerIndex: answerIndex,
      timestamp: Date.now()
    });
    
    // Disable all buttons and highlight selection
    document.querySelectorAll('.answer-btn').forEach(btn => {
      btn.classList.add('disabled');
      btn.onclick = null;
    });
    document.getElementById('answer-' + answerIndex).classList.add('selected');
    
    // Show status with icon
    document.getElementById('status-icon').textContent = '‚úì';
    document.getElementById('status-text').textContent = 'Answer submitted!';
    document.getElementById('status-message').classList.remove('hidden');
    
    // Add haptic feedback if available
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLEANUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Handle disconnect
window.addEventListener('beforeunload', () => {
  if (gameRef && playerId) {
    gameRef.child('players/' + playerId).remove();
  }
});

// Prevent accidental refresh during game
window.addEventListener('beforeunload', (e) => {
  if (document.getElementById('game-screen').classList.contains('active')) {
    e.preventDefault();
    e.returnValue = 'Game in progress. Are you sure you want to leave?';
    return e.returnValue;
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCORES REVIEW (Between Round 1 and Round 2)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

gameRef.child('showScoresReview').on('value', (snapshot) => {
  if (snapshot.val() === true) {
    showPlayerScoresReview();
  }
});

function showPlayerScoresReview() {
  console.log('üìä Showing scores review on player screen');
  
  // Hide other screens
  document.getElementById('question-screen').classList.remove('active');
  document.getElementById('voting-screen').classList.remove('active');
  document.getElementById('waiting-screen').classList.remove('active');
  
  // Get scores from Firebase
  gameRef.once('value', (snapshot) => {
    const data = snapshot.val();
    const team1Score = data.team1ScoreAfterRound1 || 0;
    const team2Score = data.team2ScoreAfterRound1 || 0;
    
    // Show scores screen
    const scoresDiv = document.createElement('div');
    scoresDiv.id = 'player-scores-review';
    scoresDiv.style.cssText = 'position: fixed; inset: 0; background: linear-gradient(135deg, #0a1628 0%, #1a2b4a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; padding: 30px; text-align: center;';
    scoresDiv.innerHTML = `
      <div style="font-family: 'Bebas Neue', sans-serif; font-size: 42px; color: #ffc629; text-shadow: 0 0 30px rgba(255,198,41,0.6); margin-bottom: 40px; letter-spacing: 4px;">
        After Round 1
      </div>
      
      <div style="display: flex; gap: 40px; margin-bottom: 40px;">
        <div style="text-align: center;">
          <div style="font-family: 'Barlow Condensed', sans-serif; font-size: 20px; color: rgba(255,255,255,0.7); margin-bottom: 15px;">${data.team1.flag} ${data.team1.name}</div>
          <div style="font-family: 'Bebas Neue', sans-serif; font-size: 72px; color: #4dd4e8; text-shadow: 0 0 30px rgba(77,212,232,0.6);">${team1Score}</div>
        </div>
        
        <div style="font-family: 'Bebas Neue', sans-serif; font-size: 48px; color: rgba(255,255,255,0.5); align-self: center;">-</div>
        
        <div style="text-align: center;">
          <div style="font-family: 'Barlow Condensed', sans-serif; font-size: 20px; color: rgba(255,255,255,0.7); margin-bottom: 15px;">${data.team2.flag} ${data.team2.name}</div>
          <div style="font-family: 'Bebas Neue', sans-serif; font-size: 72px; color: #d4145a; text-shadow: 0 0 30px rgba(212,20,90,0.6);">${team2Score}</div>
        </div>
      </div>
      
      <div style="font-family: 'Barlow', sans-serif; font-size: 18px; color: #4dd4e8; margin-top: 20px;">
        Round 2 coming up...
      </div>
      
      <div class="spinner" style="margin-top: 20px;"></div>
    `;
    
    document.body.appendChild(scoresDiv);
  });
  
  // Listen for scores review to end
  gameRef.child('showScoresReview').on('value', (snapshot) => {
    if (snapshot.val() === false) {
      const scoresDiv = document.getElementById('player-scores-review');
      if (scoresDiv) scoresDiv.remove();
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROUND 2 - PUNNED IT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Listen for Round 2 explainer
gameRef.child('showRound2Explainer').on('value', (snapshot) => {
  if (snapshot.val() === true) {
    showPlayerRound2Explainer();
  }
});

function showPlayerRound2Explainer() {
  console.log('üì± Showing Round 2 explainer on player screen');
  
  // Hide other screens
  document.getElementById('question-screen').classList.remove('active');
  document.getElementById('voting-screen').classList.remove('active');
  document.getElementById('waiting-screen').classList.remove('active');
  
  // Show explainer
  const explainerDiv = document.createElement('div');
  explainerDiv.id = 'player-round2-explainer';
  explainerDiv.style.cssText = 'position: fixed; inset: 0; background: linear-gradient(135deg, #0a1628 0%, #1a2b4a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; padding: 30px; text-align: center;';
  explainerDiv.innerHTML = `
    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 64px; color: #ffc629; text-shadow: 0 0 30px rgba(255,198,41,0.6); margin-bottom: 30px; letter-spacing: 4px;">
      ROUND 2
    </div>
    
    <div style="font-family: 'Oswald', sans-serif; font-size: 32px; color: #fff; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 2px;">
      ‚öΩ Punned It ‚öΩ
    </div>
    
    <div style="font-family: 'Barlow', sans-serif; font-size: 20px; color: rgba(255,255,255,0.9); line-height: 1.6; margin-bottom: 20px; max-width: 500px;">
      Turn footballer names into puns on a given theme!
    </div>
    
    <div style="font-family: 'Barlow', sans-serif; font-size: 18px; color: rgba(255,255,255,0.7); line-height: 1.6; margin-bottom: 40px;">
      You'll have 60 seconds. Be creative!
    </div>
    
    <div style="font-family: 'Barlow', sans-serif; font-size: 18px; color: #4dd4e8; margin-top: 20px;">
      Starting soon...
    </div>
    
    <div class="spinner" style="margin-top: 20px;"></div>
  `;
  
  document.body.appendChild(explainerDiv);
  
  // Listen for round to start
  gameRef.child('round2Active').once('value', (snapshot) => {
    if (snapshot.val() === true) {
      const explainer = document.getElementById('player-round2-explainer');
      if (explainer) explainer.remove();
      startPlayerRound2();
    }
  });
}

// Listen for Round 2 to start
gameRef.child('round2Active').on('value', (snapshot) => {
  if (snapshot.val() === true) {
    const explainer = document.getElementById('player-round2-explainer');
    if (explainer) explainer.remove();
    startPlayerRound2();
  }
});

function startPlayerRound2() {
  console.log('üéØ Round 2 starting on player screen');
  
  // Hide other screens
  document.getElementById('question-screen').classList.remove('active');
  document.getElementById('voting-screen').classList.remove('active');
  document.getElementById('waiting-screen').classList.remove('active');
  
  // Show Round 2 screen
  document.getElementById('pun-input-screen').classList.add('active');
  
  // Update player info
  document.getElementById('pun-player-name').textContent = playerName;
  document.getElementById('pun-score').textContent = players[playerId]?.score || 0;
  
  // Show team badge if in team mode
  if (players[playerId]?.team) {
    const teamBadge = document.getElementById('pun-team-badge');
    teamBadge.style.display = 'block';
    teamBadge.textContent = players[playerId].team === 1 ? 'üè†' : '‚úàÔ∏è';
  }
  
  // Get category from Firebase
  gameRef.child('round2Category').once('value', (snapshot) => {
    const category = snapshot.val();
    document.getElementById('player-pun-category').textContent = category;
  });
  
  // Reset input
  document.getElementById('pun-input').value = '';
  document.getElementById('pun-submit-btn').disabled = false;
  document.getElementById('pun-status').classList.add('hidden');
  
  // Create submitted puns display area if it doesn't exist
  let submittedPunsDiv = document.getElementById('player-submitted-puns');
  if (!submittedPunsDiv) {
    submittedPunsDiv = document.createElement('div');
    submittedPunsDiv.id = 'player-submitted-puns';
    submittedPunsDiv.style.cssText = 'margin-top: 20px; display: flex; flex-direction: column; gap: 10px;';
    document.querySelector('.pun-input-area').appendChild(submittedPunsDiv);
  }
  submittedPunsDiv.innerHTML = '';
  
  // Listen for my own pun submissions
  gameRef.child(`round2/puns/${playerId}`).on('child_added', (snapshot) => {
    displayMySubmittedPun(snapshot.val());
  });
}

function displayMySubmittedPun(punText) {
  const submittedPunsDiv = document.getElementById('player-submitted-puns');
  
  const punCard = document.createElement('div');
  punCard.style.cssText = 'background: rgba(77,212,232,0.2); border: 2px solid #4dd4e8; border-radius: 8px; padding: 15px; font-family: "Barlow", sans-serif; font-size: 18px; color: #fff;';
  punCard.innerHTML = `
    <div style="font-size: 14px; color: #4dd4e8; margin-bottom: 5px;">‚úì Your pun:</div>
    <div style="font-style: italic;">"${punText}"</div>
  `;
  
  submittedPunsDiv.appendChild(punCard);
}

function submitPun() {
  const punInput = document.getElementById('pun-input');
  const pun = punInput.value.trim();
  
  if (!pun) {
    alert('Please enter a pun!');
    return;
  }
  
  // Get current puns count for this player
  gameRef.child(`round2/puns/${playerId}`).once('value', (snapshot) => {
    const currentPuns = snapshot.val() || {};
    const nextIndex = Object.keys(currentPuns).length;
    
    // Submit to Firebase with index
    gameRef.child(`round2/puns/${playerId}/${nextIndex}`).set(pun).then(() => {
      console.log('‚úÖ Pun submitted');
      
      // Clear input for next pun
      punInput.value = '';
      
      // Show success message briefly
      document.getElementById('pun-status-icon').textContent = '‚úì';
      document.getElementById('pun-status-text').textContent = 'Pun added! Submit more or wait for time to run out...';
      document.getElementById('pun-status').classList.remove('hidden');
      
      setTimeout(() => {
        document.getElementById('pun-status').classList.add('hidden');
      }, 2000);
      
    }).catch((error) => {
      console.error('‚ùå Error submitting pun:', error);
      alert('Error submitting pun. Please try again.');
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PUN REVIEW (Watch on player screen)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

gameRef.child('reviewingPun').on('value', (snapshot) => {
  if (snapshot.val() === true) {
    showPunReviewOnPlayer();
  } else {
    const reviewScreen = document.getElementById('player-pun-review');
    if (reviewScreen) reviewScreen.remove();
  }
});

function showPunReviewOnPlayer() {
  // Hide input screen
  document.getElementById('pun-input-screen').classList.remove('active');
  
  // Get first player ID
  const playerIds = Object.keys(players);
  const firstPlayerId = playerIds[0];
  const isFirstPlayer = (playerId === firstPlayerId);
  
  // Show review screen
  gameRef.child('currentPunReview').on('value', (snapshot) => {
    const punData = snapshot.val();
    if (!punData) return;
    
    // Remove existing
    let reviewDiv = document.getElementById('player-pun-review');
    if (reviewDiv) reviewDiv.remove();
    
    reviewDiv = document.createElement('div');
    reviewDiv.id = 'player-pun-review';
    reviewDiv.style.cssText = 'position: fixed; inset: 0; background: linear-gradient(135deg, #0a1628 0%, #1a2b4a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; padding: 30px; text-align: center;';
    
    if (isFirstPlayer) {
      // First player (referee) sees Accept/Reject buttons
      reviewDiv.innerHTML = `
        <div style="font-family: 'Barlow Condensed', sans-serif; font-size: 20px; color: #ffc629; margin-bottom: 30px; letter-spacing: 2px; text-transform: uppercase;">
          ‚öΩ You are the Referee ‚öΩ
        </div>
        
        <div style="font-family: 'Barlow', sans-serif; font-size: 36px; color: #fff; font-style: italic; margin-bottom: 40px; max-width: 500px; line-height: 1.4;">
          "${punData.pun}"
        </div>
        
        <div style="font-family: 'Barlow', sans-serif; font-size: 16px; color: #4dd4e8; margin-bottom: 30px;">
          Accept or Reject?
        </div>
        
        <div style="display: flex; gap: 20px;">
          <button class="pun-submit-btn" style="background: #d4145a; flex: 1;" onclick="rejectPunAsPlayer()">
            ‚ùå REJECT
          </button>
          <button class="pun-submit-btn" style="background: #4dd4e8; flex: 1;" onclick="acceptPunAsPlayer()">
            ‚úì ACCEPT
          </button>
        </div>
      `;
    } else {
      // Other players wait for referee
      reviewDiv.innerHTML = `
        <div style="font-family: 'Barlow', sans-serif; font-size: 36px; color: #fff; font-style: italic; margin-bottom: 40px; max-width: 500px; line-height: 1.4;">
          "${punData.pun}"
        </div>
        
        <div style="font-family: 'Barlow', sans-serif; font-size: 18px; color: #4dd4e8;">
          The referee is reviewing...
        </div>
      `;
    }
    
    document.body.appendChild(reviewDiv);
  });
}

function acceptPunAsPlayer() {
  gameRef.child('currentPunIndex').once('value', (snapshot) => {
    const index = snapshot.val();
    gameRef.child('punDecision').set({
      index: index,
      accepted: true,
      timestamp: Date.now()
    });
  });
}

function rejectPunAsPlayer() {
  gameRef.child('currentPunIndex').once('value', (snapshot) => {
    const index = snapshot.val();
    gameRef.child('punDecision').set({
      index: index,
      accepted: false,
      timestamp: Date.now()
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// OFFSIDE TRAP LISTENER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Listen for my offside trap opportunity
gameRef.child(`offsideTrapOpportunity/${playerId}`).on('value', (snapshot) => {
  if (snapshot.val()) {
    console.log('üö© Got Offside Trap opportunity!');
    showOffsideTrapButton();
    
    // Clear the opportunity so it doesn't trigger again
    gameRef.child(`offsideTrapOpportunity/${playerId}`).remove();
  }
});

// ROUND 3 - INTERVIEW & VOTING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function startRound3() {
  document.getElementById('game-screen').classList.remove('active');
  document.getElementById('voting-screen').classList.add('active');
  document.getElementById('voting-player-name').textContent = playerName;
  document.getElementById('voting-score').textContent = currentScore;
  
  // Show team badge
  gameRef.child('players/' + playerId + '/team').once('value', (snapshot) => {
    const teamNumber = snapshot.val();
    if (teamNumber) {
      gameRef.child('team' + teamNumber).once('value', (teamSnapshot) => {
        const teamInfo = teamSnapshot.val();
        if (teamInfo) {
          const badge = document.getElementById('voting-team-badge');
          badge.textContent = teamInfo.flag + ' ' + teamInfo.name;
          badge.style.display = 'block';
        }
      });
    }
  });
  
  // Listen for Round 3 questions
  gameRef.child('currentRound3Question').on('value', (snapshot) => {
    const questionIndex = snapshot.val();
    if (questionIndex !== null && questionIndex !== round3CurrentQ) {
      round3CurrentQ = questionIndex;
      loadRound3Question(questionIndex);
    }
  });
}

function loadRound3Question(index) {
  if (index >= ROUND_3_QUESTIONS.length) return;
  
  const q = ROUND_3_QUESTIONS[index];
  document.getElementById('voting-header-text').textContent = q.question;
  document.getElementById('voting-status').classList.add('hidden');
  
  // Get this player's answer options from Firebase
  gameRef.child('round3/' + index + '/playerOptions/' + playerId).once('value', (snapshot) => {
    const options = snapshot.val();
    if (options && options.length > 0) {
      showRound3AnswerOptions(options, index);
    } else {
      // Host hasn't set options yet, wait
      document.getElementById('vote-options').innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">Waiting for question...</div>';
      
      // Listen for when options are set
      gameRef.child('round3/' + index + '/playerOptions/' + playerId).on('value', (snap) => {
        const opts = snap.val();
        if (opts && opts.length > 0) {
          showRound3AnswerOptions(opts, index);
        }
      });
    }
  });
}

function showRound3AnswerOptions(options, questionIndex) {
  const optionsContainer = document.getElementById('vote-options');
  const letters = ['A', 'B', 'C', 'D'];
  
  optionsContainer.innerHTML = options.map((answer, i) => `
    <button class="vote-btn" id="round3-answer-${i}" onclick="submitRound3Answer('${answer.replace(/'/g, "\\'")}', ${questionIndex})">
      <div class="vote-player-name">Option ${letters[i]}</div>
      <div class="vote-answer-text">${answer}</div>
    </button>
  `).join('');
}

function submitRound3Answer(answer, questionIndex) {
  // Check if already submitted
  if (myRound3Answers[questionIndex]) {
    return;
  }
  
  myRound3Answers[questionIndex] = answer;
  
  // Submit to Firebase
  gameRef.child('round3/' + questionIndex + '/submissions/' + playerId).set({
    answer: answer,
    votes: 0,
    timestamp: Date.now()
  });
  
  // Show status and switch to voting view
  document.getElementById('voting-status-icon').textContent = '‚úì';
  document.getElementById('voting-status-text').textContent = 'Answer submitted! Now vote for the best answer...';
  document.getElementById('voting-status').classList.remove('hidden');
  
  // Disable answer buttons
  document.querySelectorAll('.vote-btn').forEach(btn => {
    btn.classList.add('disabled');
    btn.onclick = null;
  });
  
  // Listen for all submissions to enable voting
  setTimeout(() => {
    listenForVoting(questionIndex);
  }, 2000);
}

function listenForVoting(questionIndex) {
  gameRef.child('round3/' + questionIndex + '/submissions').on('value', (snapshot) => {
    const submissions = snapshot.val() || {};
    const submissionArray = Object.entries(submissions).map(([pid, data]) => ({
      playerId: pid,
      playerName: players[pid]?.name || 'Unknown',
      answer: data.answer,
      votes: data.votes || 0
    }));
    
    // Check if all players submitted
    const totalPlayers = Object.keys(players).length;
    if (submissionArray.length >= totalPlayers) {
      showVotingOptions(submissionArray, questionIndex);
    }
  });
}

function showVotingOptions(submissions, questionIndex) {
  document.getElementById('voting-header-text').textContent = 'Vote for the best answer!';
  const optionsContainer = document.getElementById('vote-options');
  
  optionsContainer.innerHTML = submissions.map((sub, i) => {
    const isOwn = sub.playerId === playerId;
    return `
      <button class="vote-btn ${isOwn ? 'own-answer' : ''}" id="vote-option-${i}" 
              onclick="${isOwn ? '' : `voteForAnswer('${sub.playerId}', ${questionIndex})`}" 
              ${isOwn ? 'disabled' : ''}>
        <div class="vote-player-name">${sub.playerName}${isOwn ? ' (You)' : ''}</div>
        <div class="vote-answer-text">${sub.answer}</div>
      </button>
    `;
  }).join('');
}

function voteForAnswer(targetPlayerId, questionIndex) {
  // Check if already voted
  gameRef.child('round3/' + questionIndex + '/votes/' + playerId).once('value', (snapshot) => {
    if (snapshot.exists()) {
      return; // Already voted
    }
    
    // Record vote
    gameRef.child('round3/' + questionIndex + '/votes/' + playerId).set(targetPlayerId);
    
    // Increment vote count for target player
    gameRef.child('round3/' + questionIndex + '/submissions/' + targetPlayerId).once('value', (snap) => {
      const currentVotes = snap.val()?.votes || 0;
      gameRef.child('round3/' + questionIndex + '/submissions/' + targetPlayerId + '/votes').set(currentVotes + 1);
    });
    
    // Give voter a point for participating
    gameRef.child('players/' + playerId + '/score').once('value', (snap) => {
      const newScore = (snap.val() || 0) + 1;
      gameRef.child('players/' + playerId + '/score').set(newScore);
    });
    
    // Show voted status
    document.querySelectorAll('.vote-btn').forEach((btn, i) => {
      if (btn.id === 'vote-option-' + Array.from(document.querySelectorAll('.vote-btn')).findIndex(b => b.onclick && b.onclick.toString().includes(targetPlayerId))) {
        btn.classList.add('voted');
      }
      btn.classList.add('disabled');
      btn.onclick = null;
    });
    
    document.getElementById('voting-status-icon').textContent = 'üéâ';
    document.getElementById('voting-status-text').textContent = 'Vote recorded!';
    document.getElementById('voting-status').classList.remove('hidden');
    
    // Add haptic feedback
    if (navigator.vibrate) {
      navigator.vibrate(50);
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TEAM SELECTION ON MOBILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showTeamSelectionScreen() {
  document.getElementById('waiting-screen').classList.remove('active');
  document.getElementById('team-selection-mobile').classList.add('active');
  
  // Get player order
  gameRef.child('players').once('value', (snapshot) => {
    const players = snapshot.val() || {};
    const playerIds = Object.keys(players);
    const playerIndex = playerIds.indexOf(playerId);
    
    if (playerIndex === 0) {
      // Player 1 selects Team 1
      document.getElementById('team-selection-subtitle').textContent = "You'll be playing at home!";
      populateTeamOptions('team1');
    } else if (playerIndex === 1) {
      // Player 2 selects Team 2 (can select at same time as Player 1)
      document.getElementById('team-selection-subtitle').textContent = "You'll be playing away!";
      populateTeamOptions('team2');
    } else {
      // Players 3+ just wait
      document.getElementById('team-selection-subtitle').textContent = "Waiting for teams to be selected...";
      document.getElementById('team-selection-spinner').style.display = 'block';
    }
  });
  
  // Listen for when both teams are selected
  gameRef.child('teamsSelected').on('value', (snapshot) => {
    if (snapshot.val() === true) {
      // Hide team selection screen and show waiting
      document.getElementById('team-selection-mobile').classList.remove('active');
      document.getElementById('waiting-screen').classList.add('active');
      document.getElementById('waiting-message').textContent = 'Get ready! Round 1 starting soon...';
      document.getElementById('waiting-spinner').style.display = 'block';
    }
  });
  
  // Listen for game actually starting (after intro on host)
  gameRef.child('started').on('value', (snapshot) => {
    if (snapshot.val() === true) {
      document.getElementById('waiting-screen').classList.remove('active');
      startPlaying();
    }
  });
}

function populateTeamOptions(teamSlot) {
  // teamSlot is either 'team1' or 'team2'
  const grid = document.getElementById('teams-grid-mobile');
  
  // Listen for the other player's selection to filter it out
  const otherSlot = teamSlot === 'team1' ? 'team2' : 'team1';
  
  gameRef.child(`playerTeamSelections/${otherSlot}`).on('value', (snapshot) => {
    const otherTeamName = snapshot.val();
    
    // Show all teams except the one the other player selected
    grid.innerHTML = WORLD_CUP_FINALISTS
      .filter(c => !otherTeamName || c.name !== otherTeamName)
      .map((country, index) => `
        <div class="team-option-mobile" id="team-opt-mobile-${index}" onclick="selectTeamMobile(${WORLD_CUP_FINALISTS.indexOf(country)}, '${teamSlot}')">
          <div class="team-flag-mobile">${country.flag}</div>
          <div class="team-name-mobile">${country.name}</div>
        </div>
      `).join('');
    
    // If other player already selected, show message
    if (otherTeamName) {
      if (teamSlot === 'team1') {
        document.getElementById('team-selection-subtitle').textContent = "You'll be playing at home! (Away team chosen)";
      } else {
        document.getElementById('team-selection-subtitle').textContent = "You'll be playing away! (Home team chosen)";
      }
    }
  });
}

function selectTeamMobile(index, teamSlot) {
  const country = WORLD_CUP_FINALISTS[index];
  
  console.log(`Selecting ${teamSlot}:`, country.name);
  
  // Save selection immediately
  gameRef.child('playerTeamSelections').update({
    [teamSlot]: country.name
  }).then(() => {
    console.log(`‚úÖ ${teamSlot} saved:`, country.name);
    document.getElementById('team-selection-subtitle').textContent = 'Waiting for other player...';
    document.getElementById('teams-grid-mobile').style.display = 'none';
    document.getElementById('team-selection-spinner').style.display = 'block';
  }).catch((error) => {
    console.error(`‚ùå Error saving ${teamSlot}:`, error);
    alert('Error selecting team. Please try again.');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLEANUP & UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SABOTAGE BUTTON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showOffsideTrapButton() {
  const overlay = document.getElementById('offside-overlay');
  overlay.classList.add('active');
  
  let offsideTrapTimeLeft = 15;
  document.getElementById('offside-timer').textContent = offsideTrapTimeLeft;
  
  // Countdown timer
  const offsideTrapTimer = setInterval(() => {
    offsideTrapTimeLeft--;
    document.getElementById('offside-timer').textContent = offsideTrapTimeLeft;
    
    if (offsideTrapTimeLeft <= 0) {
      hideOffsideTrapButton(offsideTrapTimer);
    }
  }, 1000);
  
  // Vibrate if available
  if (navigator.vibrate) {
    navigator.vibrate([200, 100, 200]);
  }
  
  // Store timer reference for cleanup
  window.offsideTrapTimer = offsideTrapTimer;
}

function hideOffsideTrapButton(timer) {
  if (timer) clearInterval(timer);
  if (window.offsideTrapTimer) clearInterval(window.offsideTrapTimer);
  document.getElementById('offside-overlay').classList.remove('active');
}

function useOffsideTrap() {
  // Get player's team and target the other team
  gameRef.child('players/' + playerId + '/team').once('value', (snapshot) => {
    const myTeam = snapshot.val();
    const targetTeam = myTeam === 1 ? 2 : 1;
    
    // Trigger offside trap - steal 2 points from EACH player on other team
    gameRef.child('offsideTrapUsed').set({
      userId: playerId,
      userTeam: myTeam,
      targetTeam: targetTeam,
      timestamp: Date.now()
    });
    
    // Hide button
    hideOffsideTrapButton(window.offsideTrapTimer);
    
    // Show success message
    alert('üö© OFFSIDE TRAP SPRUNG! -2 points from each opponent!');
    
    // Vibrate success
    if (navigator.vibrate) {
      navigator.vibrate([100, 50, 100, 50, 100]);
    }
  });
}

// Listen for offside trap being caught
gameRef.child('offsideTrapUsed').on('value', (snapshot) => {
  const trapData = snapshot.val();
  if (!trapData) return;
  
  // Check if I'm on the team that got trapped
  const myTeam = players[playerId]?.team;
  if (myTeam && myTeam === trapData.targetTeam) {
    // I got caught! Lose 2 points
    if (players[playerId]) {
      players[playerId].score = Math.max(0, (players[playerId].score || 0) - 2);
      gameRef.child(`players/${playerId}/score`).set(players[playerId].score);
    }
    
    // Play offside audio on my phone
    console.log('üö© Caught offside! Playing audio');
    const offsideAudio = new Audio('offside_caught.mp3?v=2');
    offsideAudio.volume = 0.8;
    offsideAudio.play()
      .then(() => console.log('üîä Playing offside caught audio'))
      .catch(err => console.error('offside_caught play failed:', err));
    
    // Vibrate
    if (navigator.vibrate) {
      navigator.vibrate([300, 100, 300, 100, 300]);
    }
    
    // Show alert
    setTimeout(() => {
      alert('üö© OFFSIDE! You lost 2 points!');
    }, 500);
  }
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLEANUP & UTILITIES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Auto-uppercase game code as user types
document.getElementById('code-input').addEventListener('input', (e) => {
  e.target.value = e.target.value.toUpperCase();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEAD PLAYER CONTROLS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function revealAnswerAsLead() {
  if (!isLeadPlayer) return;
  gameRef.update({ revealAnswer: true });
}

function nextQuestionAsLead() {
  if (!isLeadPlayer) return;
  gameRef.child('currentQuestion').once('value', (snapshot) => {
    const current = snapshot.val() || 0;
    gameRef.update({ nextQuestion: current + 1 });
  });
}

function showPlayerRound1Explainer() {
  console.log('üì± Showing Round 1 explainer on player screen');
  
  // Hide team selection if still showing
  document.getElementById('team-selection-mobile').classList.remove('active');
  document.getElementById('waiting-screen').classList.remove('active');
  
  // Show explainer screen
  const explainerDiv = document.createElement('div');
  explainerDiv.id = 'player-round1-explainer';
  explainerDiv.style.cssText = 'position: fixed; inset: 0; background: linear-gradient(135deg, #0a1628 0%, #1a2b4a 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; padding: 30px; text-align: center;';
  explainerDiv.innerHTML = `
    <div style="font-family: 'Bebas Neue', sans-serif; font-size: 64px; color: #ffc629; text-shadow: 0 0 30px rgba(255,198,41,0.6); margin-bottom: 30px; letter-spacing: 4px;">
      ROUND 1
    </div>
    
    <div style="font-family: 'Oswald', sans-serif; font-size: 32px; color: #fff; margin-bottom: 25px; text-transform: uppercase; letter-spacing: 2px;">
      ‚öΩ Sing When You're Beginning ‚öΩ
    </div>
    
    <div style="font-family: 'Barlow', sans-serif; font-size: 20px; color: rgba(255,255,255,0.9); line-height: 1.6; margin-bottom: 20px; max-width: 500px;">
      We give you the lyrics, you give us the country
    </div>
    
    <div style="font-family: 'Barlow', sans-serif; font-size: 18px; color: rgba(255,255,255,0.7); line-height: 1.6; margin-bottom: 40px;">
      Answer correctly to score points for your team!
    </div>
    
    <div id="round1-start-controls" style="display: none; flex-direction: column; gap: 15px; align-items: center;">
      <div style="font-family: 'Barlow', sans-serif; font-size: 16px; color: #4dd4e8; margin-bottom: 10px; font-style: italic;">
        You joined first! Start when ready.
      </div>
      <button onclick="startRound1()" style="font-family: 'Oswald', sans-serif; font-size: 24px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; padding: 18px 50px; background: #ffc629; color: #000; border: none; cursor: pointer; box-shadow: 0 6px 0 #d4a317, 0 10px 20px rgba(0,0,0,0.4);">
        üéÆ START ROUND 1
      </button>
    </div>
    
    <div id="round1-wait-message" style="font-family: 'Barlow', sans-serif; font-size: 18px; color: #4dd4e8; margin-top: 20px;">
      Waiting for first player to start...
    </div>
    
    <div id="round1-wait-spinner" class="spinner" style="margin-top: 20px;"></div>
  `;
  
  document.body.appendChild(explainerDiv);
  
  // Check if this player is first player
  gameRef.child('players').once('value', (snapshot) => {
    const players = snapshot.val() || {};
    const playerIds = Object.keys(players);
    const isFirst = playerIds.indexOf(playerId) === 0;
    
    if (isFirst) {
      console.log('üéÆ Player 1 can start Round 1');
      document.getElementById('round1-start-controls').style.display = 'flex';
      document.getElementById('round1-wait-message').style.display = 'none';
      document.getElementById('round1-wait-spinner').style.display = 'none';
    }
  });
  
  // Listen for round starting
  gameRef.child('round1Started').on('value', (snapshot) => {
    if (snapshot.val() === true) {
      const explainer = document.getElementById('player-round1-explainer');
      if (explainer) explainer.remove();
      // Game will start via the 'started' listener
    }
  });
}

function startRound1() {
  console.log('üéÆ Player 1 starting Round 1');
  
  // Hide start button
  document.getElementById('round1-start-controls').style.display = 'none';
  document.getElementById('round1-wait-message').style.display = 'block';
  document.getElementById('round1-wait-message').textContent = 'Starting game...';
  document.getElementById('round1-wait-spinner').style.display = 'block';
  
  // Trigger host to start Round 1
  gameRef.update({
    round1Started: true
  }).then(() => {
    console.log('‚úÖ Round 1 start signal sent');
  }).catch((error) => {
    console.error('‚ùå Error starting Round 1:', error);
  });
}
</script>

</body>
</html>
